<script>
  // main.js

  $(document).ready(function () {
    initializeSidebar();
    checkLoginStatus();
    setupEventListeners();
  });

  function initializeSidebar() {
    $('.sidebar-dropdown-menu').slideUp('fast');

    $('.sidebar-menu-item.has-dropdown > a, .sidebar-dropdown-menu-item.has-dropdown > a').click(function (e) {
      e.preventDefault();
      if (!$(this).parent().hasClass('focused')) {
        $(this).parent().parent().find('.sidebar-dropdown-menu').slideUp('fast');
        $(this).parent().parent().find('.has-dropdown').removeClass('focused');
      }
      $(this).next().slideToggle('fast');
      $(this).parent().toggleClass('focused');
    });

    $('.sidebar-toggle').click(function () {
      $('.sidebar').toggleClass('collapsed');
    });

    $('.sidebar-overlay').click(function () {
      $('.sidebar').addClass('collapsed');
      $('.sidebar-dropdown-menu').slideUp('fast');
      $('.sidebar-menu-item.has-dropdown, .sidebar-dropdown-menu-item.has-dropdown').removeClass('focused');
    });

    if (window.innerWidth < 768) {
      $('.sidebar').addClass('collapsed');
    }
  }

  function setupEventListeners() {
    $('#loginForm').submit(handleLoginSubmit);
    $('#profileForm').submit(handleProfileSubmit);
    $('#addUserForm').submit(handleAddUserSubmit);
    $('#editUserForm').submit(handleEditUserSubmit);
    $('#toggleLoginPassword').click(togglePasswordVisibility);
    $('#toggleProfilePassword').click(togglePasswordVisibility);
    $('#toggleAddUserPassword').click(togglePasswordVisibility);
  }

  function handleLoginSubmit(e) {
    e.preventDefault();
    const email = $('#loginEmail').val().trim();
    const password = $('#loginPassword').val();

    if (!email || !password) {
      showAlert('กรุณากรอกอีเมลและรหัสผ่าน', 'warning');
      return;
    }

    if (!isValidEmail(email)) {
      showAlert('รูปแบบอีเมลไม่ถูกต้อง', 'warning');
      return;
    }

    showLoading();
    google.script.run.withSuccessHandler(handleLoginSuccess).withFailureHandler(handleLoginFailure).authenticateUser(email, password);
  }

  function handleLoginFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + error, 'danger');
  }

  function handleProfileSubmit(e) {
    e.preventDefault();
    const newPassword = $('#profilePassword').val().trim();
    const userData = {
      Name: $('#profileName').val().trim(),
      Email: $('#profileEmail').val().trim(),
    };

    if (newPassword) {
      const passwordStrength = checkPasswordStrength(newPassword);
      if (!passwordStrength.valid) {
        showAlert(passwordStrength.message, 'warning');
        return;
      }
      userData.Password = newPassword;
    }

    showLoading();
    google.script.run
      .withSuccessHandler(handleProfileUpdateSuccess)
      .withFailureHandler(handleProfileUpdateFailure)
      .updateUserData(userData.Email, userData);
  }

  function handleProfileUpdateSuccess(result) {
    hideLoading();
    if (result.success) {
      showAlert('อัพเดตข้อมูลสำเร็จ', 'success');
      $('#profileModal').modal('hide');
      updateStoredUserSession($('#profileName').val().trim());
      checkLoginStatus();
    } else {
      showAlert(result.message || 'ไม่สามารถอัพเดตข้อมูลได้', 'danger');
    }
  }

  function handleProfileUpdateFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการอัพเดตข้อมูล: ' + error, 'danger');
  }

  function handleAddUserSubmit(e) {
    e.preventDefault();
    const userData = {
      email: $('#addUserEmail').val().trim(),
      name: $('#addUserName').val().trim(),
      password: $('#addUserPassword').val(),
      role: $('#addUserRole').val(),
    };

    if (!userData.email || !userData.name || !userData.password || !userData.role) {
      showAlert('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
      return;
    }

    if (!isValidEmail(userData.email)) {
      showAlert('กรุณากรอกอีเมลให้ถูกต้อง', 'warning');
      return;
    }

    showLoading();
    google.script.run.withSuccessHandler(handleAddUserSuccess).withFailureHandler(handleAddUserFailure).addUser(userData);
  }

  function handleAddUserSuccess(result) {
    hideLoading();
    if (result.success) {
      showAlert('เพิ่มผู้ใช้งานใหม่สำเร็จ', 'success');
      $('#addUserModal').modal('hide');
      loadUserList();
    } else {
      showAlert('ไม่สามารถเพิ่มผู้ใช้ได้: ' + result.message, 'danger');
    }
  }

  function handleAddUserFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้: ' + error, 'danger');
  }

  function handleEditUserSubmit(e) {
    e.preventDefault();
    const userData = {
      email: $('#editUserEmail').val().trim(),
      name: $('#editUserName').val().trim(),
      role: $('#editUserRole').val(),
    };

    if (!userData.email || !userData.name || !userData.role) {
      showAlert('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
      return;
    }

    showLoading();
    google.script.run.withSuccessHandler(handleEditUserSuccess).withFailureHandler(handleEditUserFailure).updateUserByAdmin(userData.email, userData);
  }

  function handleEditUserSuccess(result) {
    hideLoading();
    if (result.success) {
      showAlert('แก้ไขข้อมูลผู้ใช้สำเร็จ', 'success');
      $('#editUserModal').modal('hide');
      loadUserList();
    } else {
      showAlert('ไม่สามารถแก้ไขข้อมูลผู้ใช้ได้: ' + result.message, 'danger');
    }
  }

  function handleEditUserFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการแก้ไขข้อมูลผู้ใช้: ' + error, 'danger');
  }

  function togglePasswordVisibility() {
    const button = $(this);
    const targetId = button.data('target');
    const passwordInput = $('#' + targetId);
    const icon = button.find('i');

    if (passwordInput.length) {
      const currentType = passwordInput.attr('type');
      const newType = currentType === 'password' ? 'text' : 'password';

      passwordInput.attr('type', newType);
      icon.toggleClass('ri-eye-line ri-eye-off-line');
    }
  }

  $(document).ready(function () {
    $('.toggle-password').on('click', togglePasswordVisibility);

    $('#changePasswordForm').on('submit', function (e) {
      e.preventDefault();
      // ที่นี่คุณสามารถเพิ่มโค้ดสำหรับการส่งฟอร์มได้
      console.log('Form submitted');
    });
  });

  function loadUserList() {
    showLoading();
    google.script.run.withSuccessHandler(displayUserList).withFailureHandler(handleLoadUserListFailure).getAllUsers();
  }

  function displayUserList(users) {
    hideLoading();
    const userListHtml = users
      .map(
        (user) => `
        <tr>
            <td>${escapeHtml(user.email)}</td>
            <td>${escapeHtml(user.name)}</td>
            <td>${escapeHtml(user.role)}</td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="editUser('${escapeHtml(user.email)}')">แก้ไข</button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser('${escapeHtml(user.email)}')">ลบ</button>
            </td>
        </tr>
    `
      )
      .join('');
    $('#userList').html(userListHtml);
  }

  function handleLoadUserListFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการโหลดรายชื่อผู้ใช้: ' + error, 'danger');
  }

  function editUser(email) {
    showLoading();
    google.script.run.withSuccessHandler(populateEditUserForm).withFailureHandler(handleEditUserFailure).getUserData(email);
  }

  function populateEditUserForm(userData) {
    hideLoading();
    if (userData) {
      $('#editUserEmail').val(userData.email);
      $('#editUserName').val(userData.name);
      $('#editUserRole').val(userData.role);
      $('#editUserModal').modal('show');
    } else {
      showAlert('ไม่พบข้อมูลผู้ใช้', 'warning');
    }
  }

  function deleteUser(email) {
    showConfirmationModal('ยืนยันการลบผู้ใช้', `คุณแน่ใจหรือไม่ที่จะลบผู้ใช้ ${email}?`, () => {
      showLoading();
      google.script.run.withSuccessHandler(handleDeleteUserSuccess).withFailureHandler(handleDeleteUserFailure).deleteUser(email);
    });
  }

  function handleDeleteUserSuccess(result) {
    hideLoading();
    if (result.success) {
      showAlert('ลบผู้ใช้สำเร็จ', 'success');
      loadUserList();
    } else {
      showAlert('ไม่สามารถลบผู้ใช้ได้: ' + result.message, 'danger');
    }
  }

  function handleDeleteUserFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการลบผู้ใช้: ' + error, 'danger');
  }

  function updateStoredUserSession(newName) {
    const storedSession = localStorage.getItem('userSession');
    if (storedSession) {
      const session = JSON.parse(storedSession);
      session.user.name = newName;
      localStorage.setItem('userSession', JSON.stringify(session));
    }
  }

  function handleLogout() {
    localStorage.removeItem('userSession');
    showLoginForm();
    showAlert('ออกจากระบบสำเร็จ', 'info');
  }

  function loadDashboard(user) {
    if (user && user.email) {
      showLoading();
      google.script.run.withSuccessHandler(displayDashboard).withFailureHandler(handleLoadDashboardFailure).getUserData(user.email);
    } else {
      $('#dashboardContent').html('<p>กรุณาเข้าสู่ระบบเพื่อดูข้อมูล Dashboard</p>');
    }
  }

  function displayDashboard(userData) {
    hideLoading();
    if (userData) {
      let html = '<h2>ข้อมูลส่วนตัว</h2>';
      html += `<p><strong>ชื่อ:</strong> ${escapeHtml(userData.name)}</p>`;
      html += `<p><strong>อีเมล:</strong> ${escapeHtml(userData.email)}</p>`;
      html += `<p><strong>บทบาท:</strong> ${escapeHtml(userData.role)}</p>`;
      html += '<button onclick="showProfileModal()" class="btn btn-primary">แก้ไขข้อมูลส่วนตัว</button>';
      $('#dashboardContent').html(html);
    } else {
      $('#dashboardContent').html('<p>ไม่พบข้อมูลผู้ใช้</p>');
    }
  }

  function handleLoadDashboardFailure(error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล Dashboard: ' + error, 'danger');
  }

  function showAlert(message, type = 'error') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
    document.body.insertBefore(alertDiv, document.body.firstChild);
  }

  function showForm(formId, action) {
    const modal = new bootstrap.Modal(document.getElementById('formModal'));
    const modalTitle = document.getElementById('formModalTitle');
    const modalBody = document.getElementById('formModalBody');

    modalTitle.textContent = action === 'บันทึก' ? 'บันทึกฟอร์ม' : 'แก้ไขฟอร์ม';

    // โหลดฟอร์มที่เหมาะสม
    if (action === 'บันทึก') {
      // โหลด PersonalInfo.js
      google.script.run
        .withSuccessHandler(function (html) {
          modalBody.innerHTML = html;
          modal.show();
          // เริ่มการทำงานของ PersonalInfo.js
          loadPersonalInfo();
        })
        .getPersonalInfoForm();
    } else {
      // โหลด personalInfoDisplay.js
      google.script.run
        .withSuccessHandler(function (html) {
          modalBody.innerHTML = html;
          modal.show();
          // เริ่มการทำงานของ personalInfoDisplay.js
          loadPersonalInfoDisplay();
        })
        .getPersonalInfoDisplayForm();
    }
  }

  function updateFormStatus(formId, status) {
    const statusElement = document.getElementById(`status-${formId}`);
    if (statusElement) {
      statusElement.textContent = status;
      statusElement.className = status === 'บันทึกแล้ว' ? 'text-success' : 'text-warning';
    }
  }
  // เพิ่มฟังก์ชันนี้ในไฟล์ main.js

  function checkAuthAndShowContent() {
    const userSession = JSON.parse(localStorage.getItem('userSession'));
    if (userSession && userSession.user) {
      // ผู้ใช้เข้าสู่ระบบแล้ว
      $('#loginContainer').hide();
      $('#mainContent').show();
      updateUIForLoggedInUser(userSession.user);
    } else {
      // ผู้ใช้ยังไม่ได้เข้าสู่ระบบ
      $('#loginContainer').show();
      $('#mainContent').hide();
      updateUIForLoggedOutUser();
    }
  }

  function showSettingsModal() {
    google.script.run.withSuccessHandler(populateSettingsForm).getSettings();
    $('#settingsModal').modal('show');
  }

  function populateSettingsForm(settings) {
    $('#sheetId').val(settings.SHEET_ID || '');
    $('#folderId').val(settings.PROFILE_IMAGES_FOLDER_ID || '');
    $('#academicYears').val(settings.academicYears || '');
  }

  function saveSettingsChanges() {
    const newSettings = {
      SHEET_ID: $('#sheetId').val(),
      PROFILE_IMAGES_FOLDER_ID: $('#folderId').val(),
      academicYears: $('#academicYears').val(),
    };

    google.script.run.withSuccessHandler(onSettingsSaveSuccess).withFailureHandler(onSettingsSaveFailure).saveSettings(newSettings);
  }

  function onSettingsSaveSuccess(result) {
    if (result.success) {
      showAlert('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
      $('#settingsModal').modal('hide');
    } else {
      showAlert('เกิดข้อผิดพลาดในการบันทึกการตั้งค่า: ' + result.message, 'danger');
    }
  }

  function onSettingsSaveFailure(error) {
    showAlert('เกิดข้อผิดพลาดในการบันทึกการตั้งค่า: ' + error, 'danger');
  }

  // แสดง Modal ลืมรหัสผ่าน
  function showForgotPasswordModal() {
    $('#forgotPasswordModal').modal('show');
    return false;
  }

  // จัดการการส่งฟอร์มลืมรหัสผ่าน
  function handleForgotPassword(e) {
    e.preventDefault();
    const email = $('#forgotPasswordEmail').val().trim();

    if (!email) {
      showAlert('กรุณากรอกอีเมล', 'warning');
      return false;
    }

    if (!isValidEmail(email)) {
      showAlert('รูปแบบอีเมลไม่ถูกต้อง', 'warning');
      return false;
    }

    // แสดง loading
    const submitBtn = $(e.target).find('button[type="submit"]');
    submitBtn
      .prop('disabled', true)
      .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังดำเนินการ...');

    // เรียกใช้ backend function
    google.script.run
      .withSuccessHandler(function (result) {
        submitBtn.prop('disabled', false).text('ส่งรหัสผ่านใหม่');
        if (result.success) {
          $('#forgotPasswordModal').modal('hide');
          $('#forgotPasswordForm')[0].reset();
          showAlert('ส่งรหัสผ่านใหม่ไปยังอีเมลของคุณแล้ว กรุณาตรวจสอบอีเมล', 'success');
        } else {
          showAlert(result.message || 'ไม่สามารถดำเนินการได้', 'error');
        }
      })
      .withFailureHandler(function (error) {
        submitBtn.prop('disabled', false).text('ส่งรหัสผ่านใหม่');
        showAlert('เกิดข้อผิดพลาด: ' + error, 'error');
      })
      .resetPasswordByEmail(email);

    return false;
  }

  // เพิ่ม event listener เมื่อ modal ถูกปิด
  $('#forgotPasswordModal').on('hidden.bs.modal', function () {
    $('#forgotPasswordForm')[0].reset();
  });
</script>
