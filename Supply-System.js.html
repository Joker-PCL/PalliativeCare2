<script>
  // Global variables
  let supplyItems = [];
  let currentEditIndex = -1;
  let currentPage = 1;
  const itemsPerPage = 10;
  let filteredItems = [];

  // Initialize on document ready
  $(document).ready(() => {
    try {
      loadSupplyItems();
      setupEventListeners();
    } catch (error) {
      console.error('Error during initialization:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการโหลดระบบ');
    }
  });

  // Event Listeners Setup
  function setupEventListeners() {
    $('#addSupplyForm').off();
    $('#saveSupplyButton').off();

    $('#supplyStock, #supplyPrice').on('input', calculateItemTotal);

    $('#addSupplyForm').on('submit', function (e) {
      e.preventDefault();
      handleSubmit();
    });

    $('#searchSupply').on('input', filterSupplyItems);
    $('#filterUnit').on('change', filterSupplyItems);
    $('#sortBy').on('change', sortSupplyItems);

    const fields = ['supplyCode', 'supplyName', 'supplyUnit', 'supplyStock', 'supplyMinStock', 'supplyPrice'];
    fields.forEach((field) => {
      $(`#${field}`).on('input', function () {
        if ($(this).val().trim()) {
          $(this).removeClass('is-invalid');
        }
      });
    });
  }

  // Load supply items
  function loadSupplyItems() {
    showLoading('กำลังโหลดข้อมูล...');
    google.script.run
      .withSuccessHandler((items) => {
        supplyItems = items || [];
        filteredItems = [...supplyItems];
        updateSupplyTable();
        hideLoading();
        // เรียกใช้ฟังก์ชันตรวจสอบสต็อก
        try {
          checkLowStockItems();
        } catch (error) {
          console.error('Error checking low stock items:', error);
        }
      })
      .withFailureHandler((error) => {
        hideLoading();
        showAlert('error', 'ไม่สามารถโหลดข้อมูล: ' + error);
      })
      .getSupplyItems();
  }

  // Show add supply modal
  function showAddSupplyModal() {
    resetSupplyForm();
    currentEditIndex = -1;
    $('#modalTitle').text('เพิ่มรายการพัสดุ');
    $('#supplyCode').prop('readonly', false);
    $('#saveSupplyButton').html('<i class="bi bi-plus-circle me-2"></i>เพิ่มรายการ').prop('disabled', false);
    const modal = new bootstrap.Modal(document.getElementById('addSupplyModal'));
    modal.show();
  }

  // Reset supply form
  function resetSupplyForm() {
    $('#addSupplyForm')[0].reset();
    $('.is-invalid').removeClass('is-invalid');
    $('#previewTotal').text('฿0.00');
    $('#supplyCode').prop('readonly', false);
    currentEditIndex = -1;
    $('#addSupplyForm').removeData('originalData');
    $('#saveSupplyButton').html('<i class="bi bi-plus-circle me-2"></i>เพิ่มรายการ').prop('disabled', false);
  }

  // Calculate item total
  function calculateItemTotal() {
    const stock = Number($('#supplyStock').val() || 0);
    const price = Number($('#supplyPrice').val() || 0);
    const total = stock * price;
    $('#previewTotal').text(
      '฿' +
        total.toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })
    );
  }

  // Handle form submission
  function handleSubmit() {
    if (!validateSupplyForm()) return;

    const userSession = JSON.parse(localStorage.getItem('userSession'));
    const userEmail = userSession?.user?.email || '';

    const item = {
      code: $('#supplyCode').val().trim(),
      name: $('#supplyName').val().trim(),
      unit: $('#supplyUnit').val(),
      stock: parseInt($('#supplyStock').val()),
      minStock: parseInt($('#supplyMinStock').val()),
      price: parseFloat($('#supplyPrice').val()),
      note: $('#supplyNote').val().trim() || '',
      updatedBy: userEmail,
      isEditing: currentEditIndex !== -1,
    };

    showLoading('กำลังบันทึกข้อมูล...');

    google.script.run
      .withSuccessHandler((response) => {
        hideLoading();

        if (response && response.success) {
          if (currentEditIndex !== -1) {
            supplyItems[currentEditIndex] = response.data;
          } else {
            supplyItems.push(response.data);
          }

          Swal.fire({
            icon: 'success',
            title: response.message,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
          }).then(() => {
            loadSupplyItems();
            $('#addSupplyModal').modal('hide');
            resetSupplyForm();
            currentEditIndex = -1;
          });
        } else {
          showAlert('error', (response && response.message) || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
        }
      })
      .withFailureHandler((error) => {
        hideLoading();
        console.error('Error:', error);
        showAlert('error', 'เกิดข้อผิดพลาด: ' + error);
      })
      .saveSupplyItem(item);
  }

  // Validate supply form
  function validateSupplyForm() {
    let isValid = true;
    const errorMessages = [];

    const fields = {
      supplyCode: { label: 'รหัสสินค้า' },
      supplyName: { label: 'ชื่อสินค้า' },
      supplyUnit: { label: 'หน่วยสินค้า' },
      supplyStock: {
        label: 'จำนวนสต็อกสินค้า',
        min: 0,
        type: 'number',
      },
      supplyMinStock: {
        label: 'สต็อกขั้นต่ำ',
        min: 0,
        type: 'number',
      },
      supplyPrice: {
        label: 'ราคาต่อหน่วย',
        min: 0,
        type: 'number',
      },
    };

    Object.entries(fields).forEach(([id, field]) => {
      const $el = $(`#${id}`);
      const value = $el.val().trim();

      if (!value) {
        isValid = false;
        $el.addClass('is-invalid');
        errorMessages.push(`กรุณากรอก${field.label}`);
      } else if (field.type === 'number') {
        const numValue = Number(value);
        if (isNaN(numValue) || numValue < field.min) {
          isValid = false;
          $el.addClass('is-invalid');
          errorMessages.push(`${field.label}ต้องไม่ต่ำกว่า ${field.min}`);
        } else {
          $el.removeClass('is-invalid');
        }
      } else {
        $el.removeClass('is-invalid');
      }
    });

    if (!isValid) {
      Swal.fire({
        icon: 'warning',
        title: 'ข้อมูลไม่ครบถ้วน',
        html: errorMessages.map((msg) => `<div class="text-start">- ${msg}</div>`).join(''),
        confirmButtonText: 'ตกลง',
      });
    }

    return isValid;
  }

  // Edit supply item
  function editSupplyItem(index) {
    try {
      // หา index ที่แท้จริงจาก supplyItems โดยใช้ code เป็นตัวเทียบ
      const itemToEdit = filteredItems[index];
      const originalIndex = supplyItems.findIndex((item) => item.code === itemToEdit.code);

      if (originalIndex === -1) {
        throw new Error('ไม่พบรายการที่ต้องการแก้ไข');
      }

      currentEditIndex = originalIndex;
      const item = supplyItems[originalIndex];

      $('#addSupplyForm').data('originalData', { ...item });

      $('#modalTitle').text('แก้ไขรายการพัสดุ');
      $('#supplyCode').val(item.code).prop('readonly', true);
      $('#supplyName').val(item.name);
      $('#supplyUnit').val(item.unit);
      $('#supplyStock').val(item.stock);
      $('#supplyMinStock').val(item.minStock);
      $('#supplyPrice').val(item.price);
      $('#supplyNote').val(item.note);

      calculateItemTotal();

      $('#saveSupplyButton').html('<i class="bi bi-save me-2"></i>บันทึกการแก้ไข').prop('disabled', false);

      const modal = new bootstrap.Modal(document.getElementById('addSupplyModal'));
      modal.show();
    } catch (error) {
      console.error('Error in editSupplyItem:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการแก้ไขรายการ: ' + error.message);
    }
  }

  // Cancel edit
  function cancelEdit() {
    // Reset form
    resetSupplyForm();

    // ถ้ามีข้อมูลเดิม ให้กลับไปใช้ข้อมูลเดิม
    const originalData = $('#addSupplyForm').data('originalData');
    if (originalData && currentEditIndex >= 0) {
      supplyItems[currentEditIndex] = originalData;
      updateSupplyTable();
    }

    // ล้างค่า readonly ของรหัสสินค้า
    $('#supplyCode').prop('readonly', false);

    // ปิด modal
    $('#addSupplyModal').modal('hide');
    currentEditIndex = -1;

    // แสดงข้อความแจ้งเตือน
    showAlert('info', 'ยกเลิกการแก้ไข');
  }

  // Delete supply item
  function deleteSupplyItem(index) {
    const itemToDelete = supplyItems[index];

    Swal.fire({
      title: 'ยืนยันการลบ',
      text: `คุณต้องการลบรายการ ${itemToDelete.name} ใช่หรือไม่?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'ลบ',
      cancelButtonText: 'ยกเลิก',
      reverseButtons: true,
    }).then((result) => {
      if (result.isConfirmed) {
        showLoading('กำลังลบรายการ...');

        google.script.run
          .withSuccessHandler((result) => {
            hideLoading();
            if (result.success) {
              supplyItems.splice(index, 1);
              filteredItems = [...supplyItems];
              updateSupplyTable();
              showAlert('success', result.message);
            } else {
              showAlert('error', result.message);
            }
          })
          .withFailureHandler((error) => {
            hideLoading();
            showAlert('error', 'เกิดข้อผิดพลาด: ' + error);
          })
          .deleteSupplyItem(itemToDelete.code);
      }
    });
  }

  // Filter supply items
  function filterSupplyItems() {
    const searchTerm = $('#searchSupply').val().toLowerCase();
    const unitFilter = $('#filterUnit').val();

    filteredItems = supplyItems.filter((item) => {
      const matchSearch =
        String(item.code || '')
          .toLowerCase()
          .includes(searchTerm) ||
        String(item.name || '')
          .toLowerCase()
          .includes(searchTerm) ||
        String(item.note || '')
          .toLowerCase()
          .includes(searchTerm);

      const matchUnit = !unitFilter || item.unit === unitFilter;

      return matchSearch && matchUnit;
    });

    currentPage = 1; // Reset to first page when filtering
    updateSupplyTable(filteredItems);
  }

  // Sort supply items
  function sortSupplyItems() {
    const sortBy = $('#sortBy').val();

    const sortedItems = [...filteredItems].sort((a, b) => {
      switch (sortBy) {
        case 'name':
          return a.name.localeCompare(b.name);
        case 'stock':
          return b.stock - a.stock;
        case 'price':
          return b.price - a.price;
        default:
          return 0;
      }
    });

    filteredItems = sortedItems;
    updateSupplyTable(filteredItems);
  }

  // Update supply table
  function updateSupplyTable(items = supplyItems) {
    const tbody = $('#supplyTableBody');
    tbody.empty();
    let totalAmount = 0;

    if (!items.length) {
      tbody.html(`
      <tr>
        <td colspan="9" class="text-center py-5">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted mb-1">ไม่พบรายการพัสดุ</h5>
            <p class="text-muted mb-0">กรุณาเพิ่มรายการใหม่</p>
          </div>
        </td>
      </tr>
    `);
      updatePagination(0);
      return;
    }

    // Calculate pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedItems = items.slice(startIndex, endIndex);

    paginatedItems.forEach((item, index) => {
      const total = (item.stock || 0) * (item.price || 0);
      totalAmount += total;

      const stockStatus = getStockStatusClass(item.stock, item.minStock);
      const row = `
      <tr>
        <td class="text-center">${startIndex + index + 1}</td>
        <td>${escapeHtml(item.code)}</td>
        <td>${escapeHtml(item.name)}</td>
        <td class="text-center">${escapeHtml(item.unit)}</td>
        <td class="text-end">
          <span class="badge ${stockStatus.class}">
            ${(item.stock || 0).toLocaleString()} 
            ${stockStatus.icon}
          </span>
        </td>
        <td class="text-end">${(item.price || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
        <td class="text-end">${total.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
        <td>${escapeHtml(item.note)}</td>
        <td class="text-center">
          <div class="d-flex gap-1 justify-content-center">
            <button class="btn btn-warning btn-sm" onclick="editSupplyItem(${startIndex + index})" title="แก้ไข">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteSupplyItem(${startIndex + index})" title="ลบ">
              <i class="bi bi-trash3-fill"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
      tbody.append(row);
    });

    $('#totalAmount').text(totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 }));
    updatePagination(items.length);
    updateSummaryCards();
  }

  // Update pagination
  function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) {
      $('#pageInfo').html('');
      return;
    }

    let paginationHtml = `
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-end mb-0">
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <button class="page-link" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>
  `;

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHtml += `
      <li class="page-item ${currentPage === i ? 'active' : ''}">
        <button class="page-link" onclick="changePage(${i})">${i}</button>
      </li>
    `;
    }

    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <button class="page-link" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  `;

    pagination.html(paginationHtml);

    // Update page info
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);

    $('#pageInfo').html(`
    <div class="text-muted small">
      แสดง ${startItem}-${endItem} จาก ${totalItems} รายการ
    </div>
  `);
  }

  // Change page
  function changePage(newPage) {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);

    if (newPage < 1 || newPage > totalPages) {
      return;
    }

    currentPage = newPage;
    updateSupplyTable(filteredItems);

    // Scroll to top of table
    $('.table-container').animate({ scrollTop: 0 }, 'fast');
  }

  // Get stock status class
  function getStockStatusClass(stock, minStock) {
    if (stock <= 0) {
      return {
        class: 'bg-danger text-white',
        icon: '<i class="bi bi-x-circle ms-1"></i>',
      };
    } else if (stock <= minStock) {
      return {
        class: 'bg-warning text-dark',
        icon: '<i class="bi bi-exclamation-circle ms-1"></i>',
      };
    }
    return {
      class: 'bg-success text-white',
      icon: '<i class="bi bi-check-circle ms-1"></i>',
    };
  }

  // เพิ่มฟังก์ชัน updatePercentageIcons
  function updatePercentageIcons(percent, elementId) {
    const iconElement = $(elementId).closest('.card-body').find('.percent-badge i');
    if (percent > 0) {
      iconElement.removeClass('bi-arrow-down-short').addClass('bi-arrow-up-short');
    } else {
      iconElement.removeClass('bi-arrow-up-short').addClass('bi-arrow-down-short');
    }
  }

  // แก้ไขฟังก์ชัน updateSummaryCards
  function updateSummaryCards() {
    const totalItems = supplyItems.length;
    const totalValue = supplyItems.reduce((sum, item) => {
      return sum + (item.stock || 0) * (item.price || 0);
    }, 0);

    const lowStockItems = supplyItems.filter((item) => item.stock <= item.minStock && item.stock > 0).length;

    const outOfStockItems = supplyItems.filter((item) => item.stock === 0).length;

    const lowStockPercent = totalItems > 0 ? Math.round((lowStockItems / totalItems) * 100) : 0;

    const outOfStockPercent = totalItems > 0 ? Math.round((outOfStockItems / totalItems) * 100) : 0;

    // อัพเดทค่าในการ์ด
    $('#totalItems').text(totalItems.toLocaleString());
    $('#totalValue').text(
      '฿' +
        totalValue.toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })
    );

    // อัพเดทค่าสต็อกกำลังจะหมด
    $('#lowStockItems').text(lowStockItems.toLocaleString());
    $('#lowStockPercent').text(`${lowStockPercent}%`);

    // อัพเดทค่าสต็อกหมด
    $('#outOfStockItems').text(outOfStockItems.toLocaleString());
    $('#outOfStockPercent').text(`${outOfStockPercent}%`);

    // อัพเดทไอคอนเปอร์เซ็นต์
    try {
      updatePercentageIcons(lowStockPercent, '#lowStockItems');
      updatePercentageIcons(outOfStockPercent, '#outOfStockItems');
    } catch (error) {
      console.error('Error updating percentage icons:', error);
    }
  }

  // เพิ่มฟังก์ชัน checkLowStockItems
  function checkLowStockItems() {
    const lowStockItems = supplyItems.filter((item) => item.stock <= item.minStock && item.stock > 0);

    const outOfStockItems = supplyItems.filter((item) => item.stock === 0);

    if (lowStockItems.length > 0 || outOfStockItems.length > 0) {
      let message = '';

      if (outOfStockItems.length > 0) {
        message += `<div class="mb-3">
        <strong class="text-danger">
          <i class="bi bi-x-circle me-2"></i>
          สินค้าหมดสต็อก ${outOfStockItems.length} รายการ:
        </strong>
        <ul class="mb-0 mt-2">
          ${outOfStockItems.map((item) => `<li>${item.name} (รหัส: ${item.code})</li>`).join('')}
        </ul>
      </div>`;
      }

      if (lowStockItems.length > 0) {
        message += `<div>
        <strong class="text-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          สินค้าใกล้หมด ${lowStockItems.length} รายการ:
        </strong>
        <ul class="mb-0 mt-2">
          ${lowStockItems.map((item) => `<li>${item.name} (เหลือ ${item.stock} ${item.unit} จากขั้นต่ำ ${item.minStock} ${item.unit})</li>`).join('')}
        </ul>
      </div>`;
      }

      Swal.fire({
        title: 'แจ้งเตือนสถานะสต็อก',
        icon: 'warning',
        html: message,
        confirmButtonText: 'รับทราบ',
        showConfirmButton: true,
        allowOutsideClick: false,
        allowEscapeKey: false,
        customClass: {
          confirmButton: 'btn btn-primary',
          htmlContainer: 'text-start',
        },
      });
    }
  }

  // Utility functions
  function showAlert(type, message) {
    Swal.fire({
      icon: type,
      title: message,
      timer: 3000,
      timerProgressBar: true,
      showConfirmButton: false,
    });
  }

  function showLoading(text = 'กำลังดำเนินการ...') {
    Swal.fire({
      title: text,
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });
  }

  function hideLoading() {
    Swal.close();
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  // Error handling
  window.onerror = function (message, source, lineno, colno, error) {
    console.error('Global error:', { message, source, lineno, colno, error });
    hideLoading();
    showAlert('error', 'เกิดข้อผิดพลาดในการทำงาน กรุณาลองใหม่อีกครั้ง');
    return false;
  };

  // Export functions for global use
  window.showAddSupplyModal = showAddSupplyModal;
  window.editSupplyItem = editSupplyItem;
  window.deleteSupplyItem = deleteSupplyItem;
  window.cancelEdit = cancelEdit;
  window.changePage = changePage;
  window.updatePercentageIcons = updatePercentageIcons;
  window.checkLowStockItems = checkLowStockItems;
</script>
