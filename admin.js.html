<script>
  // Admin Dashboard Management
  function loadAdminDashboard() {
    const session = JSON.parse(localStorage.getItem('userSession') || '{}');
    if (!session.user) {
      return showAlert('กรุณาเข้าสู่ระบบก่อน', 'warning');
    }
    if (session.user.role !== 'Admin') {
      return showAlert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้', 'warning');
    }

    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(displayAdminDashboard)
      .withFailureHandler((error) => handleFailure('โหลดข้อมูลผู้ใช้', error))
      .getAllUsers();
  }

  function displayAdminDashboard(users) {
    hideLoadingIndicator();
    const tableHtml = Array.isArray(users) && users.length > 0 ? generateUserTable(users) : '<p class="alert alert-info">ไม่พบข้อมูลผู้ใช้</p>';

    $('#userListContainer').html(tableHtml);
    attachUserActionListeners();
  }

  function generateUserTable(users) {
    return `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>อีเมล</th>
                    <th>ชื่อ</th>
                    <th>บทบาท</th>
                    <th>จำนวนครั้งล็อกอิน</th>
                    <th>การดำเนินการ</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(generateUserRow).join('')}
            </tbody>
        </table>
    `;
  }

  function generateUserRow(user) {
    return `
        <tr>
            <td>${escapeHtml(user.email) || 'N/A'}</td>
            <td>${escapeHtml(user.name) || 'N/A'}</td>
            <td>${escapeHtml(user.role) || 'N/A'}</td>
            <td>${user.loginAttempts || 0}</td>
            <td>
                <button class="btn btn-sm btn-primary me-2 edit-user" data-email="${escapeHtml(user.email)}">แก้ไข</button>
                <button class="btn btn-sm btn-danger delete-user" data-email="${escapeHtml(user.email)}">ลบ</button>
            </td>
        </tr>
    `;
  }

  function attachUserActionListeners() {
    $('.edit-user').on('click', function () {
      editUser($(this).data('email'));
    });
    $('.delete-user').on('click', function () {
      deleteUser($(this).data('email'));
    });
  }

  // User Management
  function handleAddUserSubmit(e) {
    e.preventDefault();
    const userData = {
      email: $('#newUserEmail').val().trim(),
      name: $('#newUserName').val().trim(),
      password: $('#newUserPassword').val(),
      role: $('#newUserRole').val(),
    };

    if (!validateUserData(userData)) return;

    showLoadingIndicator();
    google.script.run
      .withSuccessHandler((result) => handleUserOperationSuccess(result, 'เพิ่มผู้ใช้', hideAddUserForm))
      .withFailureHandler((error) => handleFailure('เพิ่มผู้ใช้', error))
      .addUser(userData);
  }

  function editUser(email) {
    showLoadingIndicator();
    google.script.run
      .withSuccessHandler(populateEditUserForm)
      .withFailureHandler((error) => handleFailure('ดึงข้อมูลผู้ใช้', error))
      .getUserData(email);
  }

  function populateEditUserForm(userData) {
    hideLoadingIndicator();
    $('#editUserEmail').val(userData.email);
    $('#editUserName').val(userData.name);
    $('#editUserRole').val(userData.role);
    $('#userListContainer').hide();
    $('#editUserForm').show();
  }

  function handleEditUserSubmit(e) {
    e.preventDefault();
    const userData = {
      email: $('#editUserEmail').val(),
      name: $('#editUserName').val().trim(),
      role: $('#editUserRole').val(),
    };

    showLoadingIndicator();
    google.script.run
      .withSuccessHandler((result) => handleUserOperationSuccess(result, 'แก้ไขข้อมูลผู้ใช้', hideEditUserForm))
      .withFailureHandler((error) => handleFailure('แก้ไขข้อมูลผู้ใช้', error))
      .updateUserByAdmin(userData.email, userData);
  }

  function deleteUser(email) {
    if (!confirm(`คุณแน่ใจหรือไม่ที่จะลบผู้ใช้ ${email}?`)) return;

    showLoadingIndicator();
    google.script.run
      .withSuccessHandler((result) => handleUserOperationSuccess(result, 'ลบข้อมูลผู้ใช้'))
      .withFailureHandler((error) => handleFailure('ลบข้อมูลผู้ใช้', error))
      .deleteUser(email);
  }

  // Utility Functions
  function handleUserOperationSuccess(result, operation, callback) {
    hideLoadingIndicator();
    if (result.success) {
      showAlert(`${operation}สำเร็จ: ${result.message}`, 'success');
      if (callback) callback();
      loadAdminDashboard();
    } else {
      showAlert(`ไม่สามารถ${operation}ได้: ${result.message}`, 'danger');
    }
  }

  function handleFailure(operation, error) {
    hideLoadingIndicator();
    showAlert(`เกิดข้อผิดพลาดในการ${operation}: ${error}`, 'danger');
  }

  function validateUserData(userData) {
    if (!userData.email || !userData.name) {
      showAlert('กรุณากรอกข้อมูลให้ครบทุกช่อง', 'warning');
      return false;
    }
    if (!isValidEmail(userData.email)) {
      showAlert('กรุณากรอกอีเมลให้ถูกต้อง', 'warning');
      return false;
    }
    const passwordStrength = checkPasswordStrength(userData.password);
    if (!passwordStrength.valid) {
      showAlert(passwordStrength.message, 'warning');
      return false;
    }
    return true;
  }

  function showLoadingIndicator() {
    $('#loadingIndicator').show();
  }

  function hideLoadingIndicator() {
    $('#loadingIndicator').hide();
  }

  function hideAddUserForm() {
    $('#addUserForm').hide();
    $('#userListContainer').show();
  }

  function hideEditUserForm() {
    $('#editUserForm').hide();
    $('#userListContainer').show();
  }

  // Make sure these functions are defined elsewhere or include them here
  // isValidEmail, checkPasswordStrength, escapeHtml, showAlert
</script>
