<script>
  // utils.js

  function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    if (!alertContainer) {
      console.error('Alert container not found');
      return;
    }

    const alertId = 'alert-' + Date.now();
    const alertHTML = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    alertContainer.insertAdjacentHTML('afterbegin', alertHTML);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      const alertElement = document.getElementById(alertId);
      if (alertElement) {
        const bsAlert = new bootstrap.Alert(alertElement);
        bsAlert.close();
      }
    }, 5000);
  }

  function updateUIForLoggedInUser(user) {
    if (user && user.name) {
      $('#userDisplayName').text(user.name);
    } else {
      $('#userDisplayName').text('User');
    }

    if (user && user.profileImage) {
      $('#profileImage').attr('src', user.profileImage);
    } else {
      $('#profileImage').attr('src', 'https://via.placeholder.com/40');
    }

    $('.dropdown-item:contains("เข้าสู่ระบบ")').hide();
    $('.dropdown-item:contains("จัดการ profile")').show();
    $('.dropdown-item:contains("ออกจากระบบ")').show();

    if (user.role === 'Admin') {
      $('.admin-only').show();
    } else {
      $('.admin-only').hide();
    }
  }

  function updateUIForLoggedOutUser() {
    $('#userDisplayName').text('Guest');
    $('#profileImage').attr('src', 'https://via.placeholder.com/40');
    $('.dropdown-item:contains("เข้าสู่ระบบ")').show();
    $('.dropdown-item:contains("จัดการ profile")').hide();
    $('.dropdown-item:contains("ออกจากระบบ")').hide();
    $('.admin-only').hide();
    $('#dashboardContent').html('<p>กรุณาเข้าสู่ระบบเพื่อดูข้อมูล Dashboard</p>');
  }

  function showLoginModal() {
    $('#loginModal').modal('show');
  }

  function showProfileModal() {
    var storedSession = localStorage.getItem('userSession');
    if (storedSession) {
      var session = JSON.parse(storedSession);
      $('#profileName').val(session.user.name);
      $('#profileEmail').val(session.user.email);
      $('#profilePassword').val('').removeClass('is-invalid');
      $('#profileForm').removeClass('was-validated');
      $('#profileModal').modal('show');
    } else {
      showAlert('กรุณาเข้าสู่ระบบก่อน', 'warning');
    }
  }

  function showAddUserModal() {
    $('#addUserModal').modal('show');
  }

  function checkLoginStatus() {
    var storedSession = localStorage.getItem('userSession');
    if (storedSession) {
      try {
        var session = JSON.parse(storedSession);
        if (session && session.user) {
          updateUIForLoggedInUser(session.user);
          if (session.user.role === 'Admin') {
            showAdminFeatures();
          } else {
            hideAdminFeatures();
          }
          loadDashboard(session.user);
        } else {
          throw new Error('Invalid session data');
        }
      } catch (error) {
        console.error('Error parsing session data:', error);
        localStorage.removeItem('userSession');
        updateUIForLoggedOutUser();
      }
    } else {
      updateUIForLoggedOutUser();
    }
  }

  function showAdminFeatures() {
    $('.admin-only').show();
  }

  function hideAdminFeatures() {
    $('.admin-only').hide();
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function checkPasswordStrength(password) {
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]+/)) strength++;
    if (password.match(/[A-Z]+/)) strength++;
    if (password.match(/[0-9]+/)) strength++;
    if (password.match(/[$@#&!]+/)) strength++;

    switch (strength) {
      case 0:
      case 1:
      case 2:
        return { valid: false, message: 'รหัสผ่านอ่อนเกินไป กรุณาใช้ตัวอักษรตัวเล็ก ตัวใหญ่ ตัวเลข และอักขระพิเศษ' };
      case 3:
        return { valid: true, message: 'รหัสผ่านปานกลาง' };
      case 4:
      case 5:
        return { valid: true, message: 'รหัสผ่านแข็งแรง' };
    }
  }

  function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  function showLoading() {
    $('body').append(`
        <div id="loading-overlay" class="position-fixed w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.5); top: 0; left: 0; z-index: 9999;">
            <div class="spinner-grow text-light" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">กำลังโหลด...</span>
            </div>
        </div>
    `);
  }

  function hideLoading() {
    $('#loading-overlay').remove();
  }

  function showConfirmationModal(title, message, onConfirm) {
    const modalId = 'confirmationModal';
    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${message}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="button" class="btn btn-primary" id="${modalId}Confirm">ยืนยัน</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();

    $(`#${modalId}Confirm`).on('click', function () {
      modal.hide();
      onConfirm();
    });

    $(`#${modalId}`).on('hidden.bs.modal', function () {
      $(this).remove();
    });
  }
</script>
