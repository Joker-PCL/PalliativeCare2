<script>
  // login.js
  $(document).ready(function () {
    console.log('Document ready, checking login status...');
    checkLoginStatus();

    // Event Listeners
    $('#loginForm').on('submit', handleLoginSubmit);
    $('#registrationForm').on('submit', handleRegistration);
  });

  function handleLoginSubmit(e) {
    e.preventDefault();
    const email = $('#loginEmail').val().trim();
    const password = $('#loginPassword').val();

    if (!email || !password) {
      showAlert('กรุณากรอกอีเมลและรหัสผ่าน', 'warning');
      return;
    }

    if (!isValidEmail(email)) {
      showAlert('รูปแบบอีเมลไม่ถูกต้อง', 'warning');
      return;
    }

    const submitBtn = $(e.target).find('button[type="submit"]');
    submitBtn
      .prop('disabled', true)
      .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังเข้าสู่ระบบ...');

    // Show loading state with Swal
    Swal.fire({
      title: 'กำลังเข้าสู่ระบบ',
      html: 'กรุณารอสักครู่...',
      allowOutsideClick: false,
      allowEscapeKey: false,
      allowEnterKey: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    google.script.run
      .withSuccessHandler(function (result) {
        submitBtn.prop('disabled', false).text('เข้าสู่ระบบ');
        if (result.success) {
          console.log('Login successful:', result);
          localStorage.setItem('userSession', JSON.stringify(result));

          // Update loading message
          Swal.update({
            title: 'เข้าสู่ระบบสำเร็จ',
            html: 'กำลังโหลดข้อมูล...',
          });

          showLoggedInUI(result.user);
          $('#loginForm')[0].reset();

          // Show welcome message after dashboard loads
          setTimeout(() => {
            Swal.fire({
              icon: 'success',
              title: 'ยินดีต้อนรับ',
              html: `คุณ ${result.user.name || result.user.email}`,
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false,
            });
          }, 1000);
        } else {
          console.log('Login failed:', result.message);
          Swal.fire({
            icon: 'error',
            title: 'เข้าสู่ระบบไม่สำเร็จ',
            text: result.message || 'ไม่สามารถเข้าสู่ระบบได้',
            confirmButtonText: 'ตกลง',
          });
        }
      })
      .withFailureHandler(function (error) {
        console.error('Login error:', error);
        submitBtn.prop('disabled', false).text('เข้าสู่ระบบ');
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + error,
          confirmButtonText: 'ตกลง',
        });
      })
      .authenticateUser(email, password);
  }

  function checkLoginStatus() {
    console.log('Checking login status...');
    const storedSession = localStorage.getItem('userSession');
    if (storedSession) {
      try {
        const session = JSON.parse(storedSession);
        if (session && session.user) {
          console.log('Found stored session');
          showLoggedInUI(session.user);
        } else {
          throw new Error('Invalid session data');
        }
      } catch (error) {
        console.error('Error parsing session data:', error);
        showLoginForm();
      }
    } else {
      console.log('No stored session found');
      showLoginForm();
    }
  }

  function showLoginForm() {
    console.log('Showing login form');
    $('#mainContent').hide();
    $('#registrationContainer').hide();
    $('#loginContainer').show();

    $('body').css('background', 'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)');
    $('#loginForm')[0].reset();

    // Update UI elements
    $('#userDisplayName').text('Guest');
    $('.dropdown-item:contains("เข้าสู่ระบบ")').show();
    $('.dropdown-item:contains("จัดการบัญชี")').hide();
    $('.dropdown-item:contains("ออกจากระบบ")').hide();
    $('.admin-only').hide();
  }

  function showLoggedInUI(user) {
    console.log('Showing logged-in UI for user:', user);
    // Hide login-related elements
    $('#loginContainer').hide();
    $('#registrationContainer').hide();

    // Show main content
    $('#mainContent').show();

    // Reset background
    $('body').css('background', '');

    // Update UI elements
    $('#userDisplayName').text(user.name || user.email);
    $('.dropdown-item:contains("เข้าสู่ระบบ")').hide();
    $('.dropdown-item:contains("จัดการบัญชี")').show();
    $('.dropdown-item:contains("ออกจากระบบ")').show();

    // Show/hide admin features
    if (user.role === 'Admin') {
      $('.admin-only').show();
    } else {
      $('.admin-only').hide();
    }

    // Load dashboard data
    loadDashboard(user);
  }

  function showRegistrationForm() {
    $('#loginContainer').hide();
    $('#mainContent').hide();
    $('#registrationContainer').show();
    $('body').css('background', 'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)');
    return false;
  }

  function handleRegistration(e) {
    e.preventDefault();
    const email = $('#registerEmail').val().trim();
    const name = $('#registerName').val().trim();
    const password = $('#registerPassword').val();
    const confirmPassword = $('#registerConfirmPassword').val();

    // Validation
    if (!email || !name || !password || !confirmPassword) {
      showAlert('กรุณากรอกข้อมูลให้ครบทุกช่อง', 'warning');
      return;
    }

    if (!isValidEmail(email)) {
      showAlert('รูปแบบอีเมลไม่ถูกต้อง', 'warning');
      return;
    }

    if (password !== confirmPassword) {
      showAlert('รหัสผ่านไม่ตรงกัน', 'warning');
      return;
    }

    const passwordStrength = checkPasswordStrength(password);
    if (!passwordStrength.valid) {
      showAlert(passwordStrength.message, 'warning');
      return;
    }

    const submitBtn = $(e.target).find('button[type="submit"]');
    submitBtn
      .prop('disabled', true)
      .html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังดำเนินการ...');

    const userData = { email, name, password };

    google.script.run
      .withSuccessHandler(function (result) {
        submitBtn.prop('disabled', false).text('สมัครสมาชิก');
        if (result.success) {
          showAlert('ลงทะเบียนสำเร็จ กรุณารอการอนุมัติจากผู้ดูแลระบบ', 'success');
          $('#registrationForm')[0].reset();
          showLoginForm();
        } else {
          showAlert(result.message || 'ไม่สามารถลงทะเบียนได้', 'error');
        }
      })
      .withFailureHandler(function (error) {
        submitBtn.prop('disabled', false).text('สมัครสมาชิก');
        showAlert('เกิดข้อผิดพลาด: ' + error, 'error');
      })
      .registerUser(userData);
  }

  function handleLogout() {
    Swal.fire({
      title: 'ยืนยันการออกจากระบบ',
      text: 'คุณแน่ใจหรือไม่ที่จะออกจากระบบ?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'ใช่, ออกจากระบบ',
      cancelButtonText: 'ยกเลิก',
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.removeItem('userSession');
        showLoginForm();
        showAlert('ออกจากระบบสำเร็จ', 'success');
      }
    });
  }

  function loadDashboard(user) {
    if (!user || !user.email) {
      $('#dashboardContent').html('<p>กรุณาเข้าสู่ระบบเพื่อดูข้อมูล Dashboard</p>');
      return;
    }

    google.script.run
      .withSuccessHandler(function (userData) {
        if (userData) {
          let html = '<h2>ข้อมูลส่วนตัว</h2>';
          html += `<p><strong>ชื่อ:</strong> ${escapeHtml(userData.name)}</p>`;
          html += `<p><strong>อีเมล:</strong> ${escapeHtml(userData.email)}</p>`;
          html += `<p><strong>บทบาท:</strong> ${escapeHtml(userData.role)}</p>`;
          html += '<button onclick="showProfileModal()" class="btn btn-primary">แก้ไขข้อมูลส่วนตัว</button>';
          $('#dashboardContent').html(html);
        } else {
          $('#dashboardContent').html('<p>ไม่พบข้อมูลผู้ใช้</p>');
        }
      })
      .withFailureHandler(function (error) {
        console.error('Error loading dashboard:', error);
        showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล Dashboard', 'error');
      })
      .getUserData(user.email);
  }

  // Utility Functions
  function showAlert(message, type) {
    Swal.fire({
      icon: type,
      title: type.charAt(0).toUpperCase() + type.slice(1),
      text: message,
      timer: 3000,
      timerProgressBar: true,
    });
  }

  function checkPasswordStrength(password) {
    if (password.length < 8) {
      return {
        valid: false,
        message: 'รหัสผ่านต้องมีความยาวอย่างน้อย 8 ตัวอักษร',
      };
    }

    let strength = 0;
    if (password.match(/[a-z]+/)) strength++;
    if (password.match(/[A-Z]+/)) strength++;
    if (password.match(/[0-9]+/)) strength++;
    if (password.match(/[$@#&!]+/)) strength++;

    if (strength < 3) {
      return {
        valid: false,
        message: 'รหัสผ่านต้องประกอบด้วยตัวอักษรตัวเล็ก ตัวใหญ่ ตัวเลข และอักขระพิเศษอย่างน้อย 3 ประเภท',
      };
    }

    return { valid: true };
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function escapeHtml(unsafe) {
    return unsafe
      ? String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')
      : '';
  }
</script>
