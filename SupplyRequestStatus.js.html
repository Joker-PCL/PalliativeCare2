<script>
  // Global variables
  let requestStatuses = [];
  let currentPage = 1;
  const itemsPerPage = 10;
  let isLoading = false;

  // Initialize when document is ready
  $(document).ready(() => {
    try {
      loadRequestStatuses();
      setupEventListeners();
      initializeComponents();
    } catch (error) {
      console.error('Error during initialization:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการโหลดระบบ');
    }
  });

  // Initialize components
  function initializeComponents() {
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
  }

  // Setup event listeners
  function setupEventListeners() {
    $('#searchRequest').on(
      'input',
      debounce(() => {
        currentPage = 1;
        filterRequests();
      }, 300)
    );

    $('#filterStatus').on('change', () => {
      currentPage = 1;
      filterRequests();
    });

    $('#sortBy').on('change', () => {
      currentPage = 1;
      sortRequests();
    });

    // Error handler
    $(document).ajaxError((event, jqXHR, settings, error) => {
      console.error('AJAX Error:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
    });
  }

  // Load request statuses
  function loadRequestStatuses() {
    if (isLoading) return;
    isLoading = true;

    showLoading('กำลังโหลดข้อมูล...');

    const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
    const userEmail = userSession?.user?.email;

    if (!userEmail) {
      hideLoading();
      showAlert('error', 'กรุณาเข้าสู่ระบบ');
      isLoading = false;
      return;
    }

    google.script.run
      .withSuccessHandler((response) => {
        hideLoading();
        isLoading = false;

        if (response && response.success) {
          requestStatuses = Array.isArray(response.data) ? response.data : [];
          currentPage = 1;
          updateRequestsTable();
          updateSummaryCards();
        } else {
          showAlert('error', response?.message || 'ไม่สามารถโหลดข้อมูลได้');
        }
      })
      .withFailureHandler((error) => {
        hideLoading();
        isLoading = false;
        showAlert('error', 'เกิดข้อผิดพลาด: ' + error?.toString());
      })
      .getRequestStatus(userEmail);
  }

  // Filter requests
  function filterRequests() {
    const searchTerm = $('#searchRequest').val()?.toLowerCase() ?? '';
    const statusFilter = $('#filterStatus').val() ?? '';

    const filteredItems = requestStatuses.filter((item) => {
      const matchSearch =
        String(item.requestCode || '')
          .toLowerCase()
          .includes(searchTerm) ||
        String(item.item || '')
          .toLowerCase()
          .includes(searchTerm) ||
        String(item.status || '')
          .toLowerCase()
          .includes(searchTerm);

      const matchStatus = !statusFilter || item.status === statusFilter;

      return matchSearch && matchStatus;
    });

    updateRequestsTable(filteredItems);
  }

  // Sort requests
  function sortRequests() {
    const sortBy = $('#sortBy').val();

    const sortedItems = [...requestStatuses].sort((a, b) => {
      switch (sortBy) {
        case 'date':
          return new Date(b.requestDate || 0) - new Date(a.requestDate || 0);
        case 'status':
          return getStatusOrder(a.status) - getStatusOrder(b.status);
        default:
          return 0;
      }
    });

    updateRequestsTable(sortedItems);
  }

  // Get status order for sorting
  function getStatusOrder(status) {
    const order = {
      รอดำเนินการ: 1,
      อนุมัติแล้ว: 2,
      ปฏิเสธ: 3,
      เสร็จสิ้น: 4,
    };
    return order[status] || 999;
  }

  // เพิ่มฟังก์ชันสำหรับแสดงรายละเอียด
  function showRequestDetails(requestCode) {
    try {
      // ค้นหาข้อมูลล่าสุดของรายการเบิก
      const request = requestStatuses.find((r) => r.requestCode === requestCode);
      if (!request) {
        showAlert('error', 'ไม่พบข้อมูลรายการ');
        return;
      }

      // อัพเดทข้อมูลก่อนแสดงผล
      const currentStatus = request.status;
      const operatorInfo = request.operator
        ? `<div class="info-item">
        <div class="info-label">ผู้ดำเนินการ</div>
        <div class="info-value">${escapeHtml(request.operator)}</div>
      </div>
      <div class="info-item">
        <div class="info-label">วันที่ดำเนินการ</div>
        <div class="info-value">${formatDate(request.updatedDate) || '-'}</div>
      </div>`
        : '';

      const detailsHtml = `
      <div class="request-details">
        <!-- ส่วนข้อมูลการเบิก -->
        <div class="details-section">
          <div class="section-header">
            <i class="bi bi-info-circle me-2"></i>
            ข้อมูลการเบิก
          </div>
          <div class="section-content">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">รหัสเบิก</div>
                <div class="info-value">${escapeHtml(request.requestCode)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">วันที่เบิก</div>
                <div class="info-value">${formatDate(request.requestDate)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">ผู้เบิก</div>
                <div class="info-value">${escapeHtml(request.requester)}</div>
              </div>
              ${operatorInfo}
            </div>
          </div>
        </div>

        <!-- ส่วนรายละเอียดพัสดุ -->
        <div class="details-section">
          <div class="section-header">
            <i class="bi bi-box me-2"></i>
            รายละเอียดพัสดุ
          </div>
          <div class="section-content">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">รายการ</div>
                <div class="info-value">${escapeHtml(request.item)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">จำนวน</div>
                <div class="info-value">${request.amount} ${escapeHtml(request.unit)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">วันที่ต้องการ</div>
                <div class="info-value">${formatDate(request.useDate)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">วัตถุประสงค์</div>
                <div class="info-value">${escapeHtml(request.purpose)}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ส่วนสถานะการดำเนินการ -->
        <div class="details-section">
          <div class="section-header">
            <i class="bi bi-clock-history me-2"></i>
            สถานะการดำเนินการ
          </div>
          <div class="section-content">
            <div class="status-badge ${getStatusBadge(currentStatus)}">
              ${escapeHtml(currentStatus || 'ไม่ระบุ')}
            </div>
            <div class="status-note">
              <div class="info-label mt-3">หมายเหตุ:</div>
              <div class="info-value">${escapeHtml(request.note) || '-'}</div>
            </div>
          </div>
        </div>
      </div>
    `;

      Swal.fire({
        title: 'รายละเอียดการเบิกพัสดุ',
        html: detailsHtml,
        width: '600px',
        showCloseButton: true,
        showConfirmButton: false,
        customClass: {
          container: 'request-details-modal',
          closeButton: 'details-close-button',
        },
      });
    } catch (error) {
      console.error('Error showing details:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการแสดงรายละเอียด');
    }
  }

  // แก้ไขฟังก์ชัน updateRequestsTable เพื่อเพิ่มปุ่มดูรายละเอียด
  function updateRequestsTable(items = requestStatuses) {
    const tbody = $('#requestTableBody');
    tbody.empty();

    if (!Array.isArray(items) || items.length === 0) {
      tbody.html(`
      <tr>
        <td colspan="7" class="text-center py-5">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="text-muted mb-1">ไม่พบรายการเบิก</h5>
            <p class="text-muted small mb-0">ไม่มีรายการเบิกที่ตรงกับเงื่อนไขการค้นหา</p>
          </div>
        </td>
      </tr>
    `);
      updatePagination(0);
      return;
    }

    // Calculate pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedItems = items.slice(startIndex, endIndex);

    // Render items
    paginatedItems.forEach((item, index) => {
      const statusBadge = getStatusBadge(item.status);
      const row = `
      <tr>
        <td class="text-center">${startIndex + index + 1}</td>
        <td>
          <div class="d-flex flex-column">
            <span class="fw-medium">${escapeHtml(item.requestCode)}</span>
            <small class="text-muted">${formatDate(item.requestDate)}</small>
          </div>
        </td>
        <td>${escapeHtml(item.item)}</td>
        <td class="text-center">
          <span class="badge bg-light text-dark">
            ${item.amount} ${escapeHtml(item.unit)}
          </span>
        </td>
        <td class="text-center">
          <span class="badge ${statusBadge}">
            ${escapeHtml(item.status || 'ไม่ระบุ')}
          </span>
        </td>
        <td>${escapeHtml(item.note || '-')}</td>
        <td class="text-center">
          <button 
            class="btn btn-outline-primary btn-sm"
            onclick="showRequestDetails('${item.requestCode}')"
          >
            <i class="bi bi-search me-1"></i>
            รายละเอียด
          </button>
        </td>
      </tr>
    `;
      tbody.append(row);
    });

    updatePagination(items.length);
    updateSummaryCards();
  }

  // Update pagination
  function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = $('#pagination');
    pagination.empty();

    if (totalPages <= 1) {
      $('#pageInfo').html('');
      return;
    }

    let paginationHtml = `
    <ul class="pagination justify-content-end mb-0">
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <button class="page-link" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
          <i class="bi bi-chevron-left"></i>
        </button>
      </li>
  `;

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHtml += `
      <li class="page-item ${currentPage === i ? 'active' : ''}">
        <button class="page-link" onclick="changePage(${i})">${i}</button>
      </li>
    `;
    }

    paginationHtml += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <button class="page-link" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
        <i class="bi bi-chevron-right"></i>
      </button>
    </li>
  </ul>`;

    pagination.html(paginationHtml);

    // Update page info
    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);

    $('#pageInfo').html(`
    <div class="text-muted small">
      แสดง ${startItem}-${endItem} จาก ${totalItems} รายการ
    </div>
  `);
  }

  // Change page
  function changePage(newPage) {
    const totalPages = Math.ceil(requestStatuses.length / itemsPerPage);

    if (newPage < 1 || newPage > totalPages) {
      return;
    }

    currentPage = newPage;
    updateRequestsTable();

    // Scroll to top of table
    $('.table-container').animate({ scrollTop: 0 }, 'fast');
  }

  // Update summary cards
  function updateSummaryCards() {
    const summary = {
      total: requestStatuses.length,
      pending: requestStatuses.filter((r) => r?.status === 'รอดำเนินการ').length,
      approved: requestStatuses.filter((r) => r?.status === 'อนุมัติแล้ว').length,
      completed: requestStatuses.filter((r) => r?.status === 'เสร็จสิ้น').length,
    };

    $('#totalRequests').text(summary.total);
    $('#pendingRequests').text(summary.pending);
    $('#approvedRequests').text(summary.approved);
    $('#completedRequests').text(summary.completed);
  }

  // Get status badge class
  function getStatusBadge(status) {
    switch (status) {
      case 'รอดำเนินการ':
        return 'bg-warning text-dark';
      case 'อนุมัติแล้ว':
        return 'bg-success text-white';
      case 'ปฏิเสธ':
        return 'bg-danger text-white';
      case 'เสร็จสิ้น':
        return 'bg-info text-white';
      default:
        return 'bg-secondary text-white';
    }
  }

  // Format date
  function formatDate(dateInput) {
    try {
      if (!dateInput) return '-';

      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return '-';

      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });
    } catch (error) {
      console.error('Error formatting date:', error);
      return '-';
    }
  }

  // Utility functions
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function showAlert(icon, title) {
    Swal.fire({
      icon,
      title,
      timer: 3000,
      timerProgressBar: true,
      showConfirmButton: false,
    });
  }

  function showLoading(text = 'กำลังดำเนินการ...') {
    Swal.fire({
      title: text,
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });
  }

  function hideLoading() {
    Swal.close();
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  function exportData() {
    const data = requestStatuses;
    if (!data || data.length === 0) {
      showAlert('warning', 'ไม่มีข้อมูลที่จะดาวน์โหลด');
      return;
    }

    try {
      // แปลงข้อมูลเป็น CSV format
      const csv = data.map((row) => {
        return [row.requestCode, formatDate(row.requestDate), row.item, `${row.amount} ${row.unit}`, row.status, row.note || '-'].join(',');
      });

      // เพิ่ม header
      csv.unshift(['รหัสเบิก', 'วันที่', 'รายการ', 'จำนวน', 'สถานะ', 'หมายเหตุ'].join(','));

      // สร้าง Blob และ download
      const blob = new Blob(['\ufeff' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `supply_requests_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    } catch (error) {
      console.error('Export error:', error);
      showAlert('error', 'เกิดข้อผิดพลาดในการดาวน์โหลดข้อมูล');
    }
  }

  // Error handling
  window.onerror = function (message, source, lineno, colno, error) {
    console.error('Global error:', { message, source, lineno, colno, error });
    hideLoading();
    showAlert('error', 'เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณาลองใหม่อีกครั้ง');
    return false;
  };

  // Export functions for global use
  window.changePage = changePage;
  window.filterRequests = filterRequests;
  window.sortRequests = sortRequests;
</script>
