<script>
  let allUsers = [];
  let currentEditingUser = null;

  // EditUser.js
  $(document).ready(function () {
    setupAdvancedSearch();
    initializeTooltips();
    loadUserList();
  });

  function initializeTooltips() {
    $('[data-bs-toggle="tooltip"]').tooltip();
  }

  function setupEventListeners() {
    // Event listeners ที่มีอยู่เดิม
    $('#saveUserChanges').click(updateUser);
    $('#resetPasswordBtn').click(showResetPasswordConfirmation);
    $('#addUserModal').on('hidden.bs.modal', () => $('#addUserForm')[0].reset());
    $('#editUserModal').on('hidden.bs.modal', () => $('#editUserForm')[0].reset());

    // เพิ่ม Event listener สำหรับการค้นหา
    $('#searchInput').on('input', function () {
      performSearch($(this).val().trim());
    });
  }

  // เพิ่มฟังก์ชัน performSearch
  function performSearch(searchTerm) {
    if (!Array.isArray(allUsers)) {
      console.error('allUsers is not properly initialized');
      return;
    }

    searchTerm = searchTerm.toLowerCase();

    const filteredUsers = allUsers.filter((user) => {
      return (
        user.email?.toLowerCase().includes(searchTerm) ||
        user.name?.toLowerCase().includes(searchTerm) ||
        user.role?.toLowerCase().includes(searchTerm) ||
        getStatusText(user.status)?.toLowerCase().includes(searchTerm)
      );
    });

    displayFilteredUsers(filteredUsers);
  }

  function displayFilteredUsers(users) {
    const userListContainer = $('#userListContainer');

    // Enhanced bulk approve button component with responsive design
    const bulkApproveButton = `
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-stretch align-items-sm-center gap-3 mb-4">
            <div class="d-flex align-items-center">
                <h4 class="m-0 text-gradient">รายการผู้ใช้งาน</h4>
                <span class="ms-2 badge bg-primary rounded-pill">${users.length}</span>
            </div>
            <button 
                class="btn btn-success btn-lg d-inline-flex align-items-center justify-content-center gap-2 position-relative overflow-hidden transition-all hover-lift"
                onclick="approveBulkUsers()" 
                id="bulkApproveBtn" 
                style="display:none"
            >
                <div class="button-content d-flex align-items-center gap-2">
                    <i class="bi bi-check-circle-fill"></i>
                    <span class="d-none d-sm-inline">อนุมัติผู้ใช้ที่เลือก</span>
                    <span class="badge bg-white text-success rounded-pill ms-1" id="selectedCount">0</span>
                </div>
                <div class="button-background position-absolute"></div>
            </button>
        </div>

        <style>
            .text-gradient {
                background: linear-gradient(45deg, #2D3748, #4A5568);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .hover-lift {
                transform: translateY(0);
                transition: all 0.2s ease;
            }
            
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 200, 83, 0.15);
            }
            
            #bulkApproveBtn {
                min-height: 48px;
                border-radius: 24px;
                padding: 0.5rem 1.5rem;
                background: linear-gradient(45deg, #2ecc71, #27ae60);
                border: none;
                font-weight: 500;
            }
            
            #bulkApproveBtn:hover {
                background: linear-gradient(45deg, #27ae60, #219a52);
            }
            
            @media (max-width: 576px) {
                #bulkApproveBtn {
                    width: 100%;
                    padding: 0.5rem 1rem;
                }
            }
            
            .button-content {
                position: relative;
                z-index: 1;
            }
            
            #selectedCount {
                min-width: 28px;
                height: 28px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 0.85rem;
            }
        </style>
    `;

    // Table header component
    const tableHeader = `
        <thead class="table-light">
            <tr>
                <th width="40" class="text-center">
                    <input 
                        type="checkbox" 
                        id="selectAllUsers" 
                        class="form-check-input"
                        onchange="toggleAllUsers(this)"
                    >
                </th>
                <th>อีเมล</th>
                <th>ชื่อ</th>
                <th>บทบาท</th>
                <th>สถานะ</th>
                <th>วันที่ลงทะเบียน</th>
                <th class="text-end">การดำเนินการ</th>
            </tr>
        </thead>
    `;

    // Generate table rows
    const tableRows = users
      .map(
        (user) => `
        <tr>
            <td class="text-center">
                ${
                  user.status === 'Pending'
                    ? `<input 
                        type="checkbox"
                        class="form-check-input user-checkbox"
                        data-email="${escapeHtml(user.email)}"
                        onchange="checkBulkActionStatus()"
                       >`
                    : ''
                }
            </td>
            <td>${escapeHtml(user.email || '')}</td>
            <td>${escapeHtml(user.name || '')}</td>
            <td>
                <span class="badge ${getRoleBadgeClass(user.role)}">
                    ${escapeHtml(user.role || '')}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(user.status)}">
                    ${escapeHtml(getStatusText(user.status))}
                </span>
            </td>
            <td>${formatDate(user.registerDate)}</td>
            <td>
                <div class="btn-group float-end">
                    ${generateActionButtons(user)}
                </div>
            </td>
        </tr>
    `
      )
      .join('');

    // Combine all components
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                ${tableHeader}
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;

    // Empty state component
    const emptyState = `
        <div class="text-center py-5">
            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">ไม่พบข้อมูลผู้ใช้</p>
        </div>
    `;

    // Render final UI
    userListContainer.html(users.length ? bulkApproveButton + tableHtml : emptyState);

    // Initialize tooltips and update bulk action status
    $('[data-bs-toggle="tooltip"]').tooltip();
    checkBulkActionStatus();
  }

  function getRoleBadgeClass(role) {
    const classes = {
      Admin: 'bg-purple text-white',
      User: 'bg-primary-subtle text-primary',
    };
    return classes[role] || 'bg-secondary';
  }

  function setupPasswordToggle() {
    const toggleButtons = document.querySelectorAll('.toggle-password');

    toggleButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        const icon = this.querySelector('i');
      });
    });
  }

  function setupRegistrationForm() {
    const form = document.getElementById('addUserForm');
    const passwordField = document.getElementById('newUserPassword');
    const strengthContainer = form?.querySelector('.password-strength-container');

    if (form && passwordField && strengthContainer) {
      // Real-time password validation
      passwordField.addEventListener('input', function (e) {
        const validationResult = updatePasswordStrength(e.target.value, strengthContainer);

        // แสดง/ซ่อนปุ่ม submit ตามความแข็งแรงของรหัสผ่าน
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = !validationResult.isValid;
          if (!validationResult.isValid) {
            submitButton.title = validationResult.message;
          } else {
            submitButton.removeAttribute('title');
          }
        }
      });

      // Submit handler
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        handleAddUserSubmit(e);
      });

      // Password toggle setup
      setupPasswordToggle();
    }
  }

  // แทนที่ฟังก์ชัน updatePasswordStrength เดิม
  function updatePasswordStrength(password, container) {
    const criteria = {
      length: password.length >= 8,
      lower: /[a-z]/.test(password),
      upper: /[A-Z]/.test(password),
      number: /\d/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
    };

    const strengthLevel = Object.values(criteria).filter(Boolean).length;

    // คำนวณเปอร์เซ็นต์ความแข็งแรง
    const strengthPercent = (strengthLevel / 5) * 100;

    // กำหนดสีตาม strength level
    let strengthColor = '';
    let strengthText = '';
    if (strengthLevel <= 2) {
      strengthColor = '#dc3545'; // สีแดง - อ่อน
      strengthText = 'อ่อน';
    } else if (strengthLevel <= 3) {
      strengthColor = '#ffc107'; // สีเหลือง - ปานกลาง
      strengthText = 'ปานกลาง';
    } else {
      strengthColor = '#198754'; // สีเขียว - แข็งแรง
      strengthText = 'แข็งแรง';
    }

    // สร้าง HTML สำหรับแสดงผล
    const strengthHtml = `
        <div class="password-strength mt-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small">ความแข็งแรงของรหัสผ่าน</span>
                <span class="small" style="color: ${strengthColor}">${strengthText}</span>
            </div>
            <div class="progress" style="height: 5px;">
                <div class="progress-bar" role="progressbar" 
                    style="width: ${strengthPercent}%; background-color: ${strengthColor}"
                    aria-valuenow="${strengthPercent}" 
                    aria-valuemin="0" 
                    aria-valuemax="100">
                </div>
            </div>
        </div>
        <div class="password-criteria mt-2">
            ${Object.entries(criteria)
              .map(
                ([key, met]) => `
                <div class="d-flex align-items-center mb-1 small">
                    <i class="bi ${met ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'} me-2"></i>
                    <span class="${met ? 'text-success' : 'text-danger'}">${getStrengthLabel(key)}</span>
                </div>
            `
              )
              .join('')}
        </div>
    `;

    container.innerHTML = strengthHtml;

    // Return วาลิเดชั่น
    return {
      isValid: strengthLevel >= 4,
      message: strengthLevel < 4 ? 'รหัสผ่านไม่ปลอดภัย กรุณาตรวจสอบเงื่อนไขด้านบน' : 'รหัสผ่านปลอดภัย',
    };
  }

  function getStrengthLabel(criteriaKey) {
    const labels = {
      length: 'ความยาวอย่างน้อย 8 ตัวอักษร',
      lower: 'ตัวอักษรพิมพ์เล็ก',
      upper: 'ตัวอักษรพิมพ์ใหญ่',
      number: 'ตัวเลข',
      special: 'อักขระพิเศษ',
    };
    return labels[criteriaKey];
  }

  async function handleAddUserSubmit(event) {
    event.preventDefault();

    const userData = {
      email: $('#newUserEmail').val().trim(),
      name: $('#newUserName').val().trim(),
      password: $('#newUserPassword').val(),
      role: $('#newUserRole').val(),
    };

    // ตรวจสอบข้อมูลเบื้องต้น
    if (!validateBasicFields(userData)) return;

    // ตรวจสอบความปลอดภัยของรหัสผ่าน
    const passwordCheck = validatePasswordStrength(userData.password);
    if (!passwordCheck.isValid) {
      Swal.fire({
        icon: 'warning',
        title: 'รหัสผ่านไม่ปลอดภัย',
        html: passwordCheck.message,
        confirmButtonText: 'ตกลง',
      });
      return;
    }

    try {
      // แสดง loading
      const loadingDialog = Swal.fire({
        title: 'กำลังดำเนินการ',
        text: 'กำลังตรวจสอบและเพิ่มผู้ใช้...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      const result = await new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addUser(userData);
      });

      loadingDialog.close();

      if (result.success) {
        // ปิด Modal และรีเซ็ตฟอร์ม
        const addUserModal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
        if (addUserModal) {
          addUserModal.hide();
          resetAddUserForm();
        }

        // แสดงผลสำเร็จ
        Swal.fire({
          icon: 'success',
          title: 'เพิ่มผู้ใช้สำเร็จ',
          text: result.autoApproved
            ? 'เพิ่มและอนุมัติผู้ใช้เรียบร้อยแล้ว ระบบได้ส่งอีเมลแจ้งผู้ใช้แล้ว'
            : 'เพิ่มผู้ใช้เรียบร้อยแล้ว รอการอนุมัติจากผู้ดูแลระบบ',
          confirmButtonText: 'ตกลง',
        }).then(() => {
          loadUserList();
        });
      } else {
        // จัดการกรณีไม่สำเร็จ
        Swal.fire({
          icon: 'error',
          title: 'ไม่สามารถเพิ่มผู้ใช้ได้',
          text: result.message,
          confirmButtonText: 'ตกลง',
        });
      }
    } catch (error) {
      console.error('Error adding user:', error);
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        text: error.message || 'ไม่สามารถเพิ่มผู้ใช้ได้ กรุณาลองใหม่อีกครั้ง',
        confirmButtonText: 'ตกลง',
      });
    }
  }

  // ฟังก์ชันตรวจสอบข้อมูลพื้นฐาน
  function validateBasicFields(userData) {
    if (!userData.email || !userData.name || !userData.password) {
      Swal.fire({
        icon: 'warning',
        title: 'ข้อมูลไม่ครบถ้วน',
        text: 'กรุณากรอกข้อมูลให้ครบทุกช่อง',
        confirmButtonText: 'ตกลง',
      });
      return false;
    }

    if (!isValidEmail(userData.email)) {
      Swal.fire({
        icon: 'warning',
        title: 'รูปแบบอีเมลไม่ถูกต้อง',
        text: 'กรุณาตรวจสอบรูปแบบอีเมล',
        confirmButtonText: 'ตกลง',
      });
      return false;
    }

    return true;
  }

  // ฟังก์ชันแสดง Error Alert
  function showErrorAlert(title, message, icon = 'error') {
    Swal.fire({
      icon: icon,
      title: title,
      text: message,
      confirmButtonText: 'ตกลง',
      customClass: {
        container: 'user-management-alert',
        popup: 'user-management-alert-popup',
        title: 'user-management-alert-title',
        confirmButton: 'btn btn-primary',
      },
    });
  }

  // เพิ่มฟังก์ชันสำหรับจัดการ Modal Backdrop
  function cleanupModalEffects() {
    // ลบ backdrop ทั้งหมดที่อาจตกค้าง
    const backdrops = document.getElementsByClassName('modal-backdrop');
    while (backdrops.length > 0) {
      backdrops[0].parentNode.removeChild(backdrops[0]);
    }

    // รีเซ็ต body classes และ styles
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  }

  // เพิ่ม CSS สำหรับ User Management Alert
  const userManagementAlertStyles = `
.user-management-alert-popup {
    font-family: 'Noto Sans Thai', sans-serif;
    border-radius: 1rem;
}

.user-management-alert-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
}

.user-management-alert .swal2-html-container {
    font-size: 1rem;
    line-height: 1.6;
    color: #34495e;
}

.user-management-alert .swal2-confirm {
    padding: 0.5rem 1.5rem;
    font-weight: 500;
}

.user-management-alert .swal2-icon {
    margin-top: 1rem;
}
`;

  // เพิ่ม styles สำหรับ alerts
  function addUserManagementAlertStyles() {
    const existingStyle = document.getElementById('user-management-alert-styles');
    if (!existingStyle) {
      const styleSheet = document.createElement('style');
      styleSheet.id = 'user-management-alert-styles';
      styleSheet.textContent = userManagementAlertStyles;
      document.head.appendChild(styleSheet);
    }
  }

  // เรียกใช้ฟังก์ชันเพิ่ม styles เมื่อ DOM โหลดเสร็จ
  document.addEventListener('DOMContentLoaded', function () {
    addUserManagementAlertStyles();
  });

  // เพิ่มฟังก์ชันรีเซ็ตฟอร์มและ UI ทั้งหมด
  function resetAddUserForm() {
    // รีเซ็ตค่าในฟอร์ม
    const form = document.getElementById('addUserForm');
    if (form) {
      // รีเซ็ตค่าในฟอร์มทั้งหมด
      form.reset();

      // รีเซ็ตตัวแสดงความแข็งแรงของรหัสผ่าน
      const strengthIndicator = form.querySelector('.password-strength-container');
      if (strengthIndicator) {
        strengthIndicator.innerHTML = '';
      }

      // รีเซ็ตไอคอนแสดง/ซ่อนรหัสผ่าน
      const passwordToggles = form.querySelectorAll('.toggle-password i');
      passwordToggles.forEach((icon) => {
        icon.className = 'bi bi-eye';
      });

      // รีเซ็ตฟิลด์รหัสผ่านให้เป็นประเภท password
      const passwordInputs = form.querySelectorAll('input[type="text"]');
      passwordInputs.forEach((input) => {
        if (input.id.toLowerCase().includes('password')) {
          input.type = 'password';
        }
      });

      // ล้าง validation styles
      form.querySelectorAll('.is-invalid').forEach((element) => {
        element.classList.remove('is-invalid');
      });
      form.querySelectorAll('.is-valid').forEach((element) => {
        element.classList.remove('is-valid');
      });
    }
  }

  // อัพเดทการจัดการ Modal
  document.addEventListener('DOMContentLoaded', function () {
    const addUserModal = document.getElementById('addUserModal');
    if (addUserModal) {
      // เมื่อ Modal ถูกเปิด
      addUserModal.addEventListener('show.bs.modal', function () {
        resetAddUserForm();
      });

      // เมื่อ Modal ถูกปิด (ไม่ว่าจะด้วยวิธีใด)
      addUserModal.addEventListener('hidden.bs.modal', function () {
        resetAddUserForm();
        cleanupModalEffects();
      });

      // จัดการปุ่มยกเลิก
      const cancelButton = addUserModal.querySelector('button[data-bs-dismiss="modal"]');
      if (cancelButton) {
        cancelButton.addEventListener('click', function () {
          resetAddUserForm();
        });
      }
    }
  });

  // ฟังก์ชันตรวจสอบข้อมูลผู้ใช้
  function validateUserInputs(userData) {
    // ตรวจสอบว่ามีข้อมูลครบถ้วน
    if (!userData.email || !userData.name || !userData.password) {
      showErrorAlert('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลให้ครบทุกช่อง', 'warning');
      return false;
    }

    // ตรวจสอบรูปแบบอีเมล
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userData.email)) {
      showErrorAlert('รูปแบบอีเมลไม่ถูกต้อง', 'กรุณาตรวจสอบรูปแบบอีเมลให้ถูกต้อง', 'warning');
      return false;
    }

    // ตรวจสอบความยาวชื่อ
    if (userData.name.length < 2) {
      showErrorAlert('ชื่อสั้นเกินไป', 'ชื่อต้องมีความยาวอย่างน้อย 2 ตัวอักษร', 'warning');
      return false;
    }

    // ตรวจสอบความซับซ้อนของรหัสผ่าน
    const passwordChecks = {
      length: userData.password.length >= 8,
      lower: /[a-z]/.test(userData.password),
      upper: /[A-Z]/.test(userData.password),
      number: /\d/.test(userData.password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(userData.password),
    };

    if (!Object.values(passwordChecks).every(Boolean)) {
      showErrorAlert(
        'รหัสผ่านไม่ปลอดภัย',
        `รหัสผ่านต้องประกอบด้วย:
            - ความยาวอย่างน้อย 8 ตัวอักษร
            - ตัวอักษรพิมพ์เล็ก
            - ตัวอักษรพิมพ์ใหญ่
            - ตัวเลข
            - อักขระพิเศษ`,
        'warning'
      );
      return false;
    }

    return true;
  }

  // ฟังก์ชันยืนยันการเพิ่มผู้ใช้
  function confirmAddUser(userData) {
    return Swal.fire({
      title: 'ยืนยันการเพิ่มผู้ใช้',
      html: `
            คุณต้องการเพิ่มผู้ใช้ต่อไปนี้ใช่หรือไม่?<br><br>
            <strong>อีเมล:</strong> ${userData.email}<br>
            <strong>ชื่อ:</strong> ${userData.name}<br>
            <strong>บทบาท:</strong> ${userData.role}
        `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'ยืนยัน',
      cancelButtonText: 'ยกเลิก',
      reverseButtons: true,
      customClass: {
        confirmButton: 'btn btn-success',
        cancelButton: 'btn btn-danger',
      },
    });
  }

  function showSuccess(message) {
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
      },
    });

    Toast.fire({
      icon: 'success',
      title: message,
    });
  }

  // ฟังก์ชันแสดงข้อผิดพลาด
  function showError(error) {
    Swal.fire({
      icon: 'error',
      title: 'เกิดข้อผิดพลาด',
      text: error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ',
      confirmButtonText: 'ตกลง',
      customClass: {
        confirmButton: 'btn btn-danger',
      },
    });
  }

  // สไตล์ CSS สำหรับ Sweetalert2
  const styles = `
.swal2-popup {
    font-family: 'Noto Sans Thai', sans-serif;
    font-size: 1rem;
}

.swal2-title {
    font-size: 1.5rem;
    font-weight: 600;
}

.swal2-html-container {
    font-size: 1rem;
    line-height: 1.6;
}

.swal2-confirm {
    font-weight: 500 !important;
}

.swal2-cancel {
    font-weight: 500 !important;
}

.swal2-popup.swal2-toast {
    padding: 0.75rem;
}
`;

  // เพิ่มสไตล์ลงในหน้าเว็บ
  const styleSheet = document.createElement('style');
  styleSheet.textContent = styles;
  document.head.appendChild(styleSheet);

  // User List Management
  function loadUserList() {
    showLoading();
    google.script.run
      .withSuccessHandler(displayUserList)
      .withFailureHandler((error) => {
        hideLoading();
        showAlert('เกิดข้อผิดพลาดในการโหลดรายชื่อผู้ใช้: ' + error, 'danger');
      })
      .getAllUsers();
  }

  function displayUserList(users) {
    hideLoading();
    allUsers = users; // เก็บข้อมูลไว้ใน global variable
    displayFilteredUsers(users);
  }

  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;

    return date.toLocaleString('th-TH', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  function generateUserTable(users) {
    return `
        <div class="mb-3">
            <button class="btn btn-success" onclick="approveBulkUsers()" id="bulkApproveBtn" style="display:none">
                <i class="bi bi-check-circle"></i> 
                อนุมัติผู้ใช้ที่เลือก
                <span id="selectedCount">0</span>
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th width="40">
                            <div class="custom-checkbox">
                                <input type="checkbox" id="selectAllUsers" onchange="toggleAllUsers(this)">
                                <span class="checkmark"></span>
                            </div>
                        </th>
                        <th>อีเมล</th>
                        <th>ชื่อ</th>
                        <th>บทบาท</th>
                        <th>สถานะ</th>
                        <th>วันที่ลงทะเบียน</th>
                        <th>การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(generateUserRow).join('')}
                </tbody>
            </table>
        </div>
    `;
  }

  function generateUserRow(user) {
    const statusBadgeClass = getStatusBadgeClass(user.status);
    const statusText = getStatusText(user.status);
    return `
        <tr>
            <td>
                ${
                  user.status === 'Pending'
                    ? `<div class="custom-checkbox">
                        <input type="checkbox" 
                            class="user-checkbox" 
                            data-email="${escapeHtml(user.email)}" 
                            onchange="checkBulkActionStatus()">
                        <span class="checkmark"></span>
                    </div>`
                    : ''
                }
            </td>
            <td>${escapeHtml(user.email)}</td>
            <td>${escapeHtml(user.name)}</td>
            <td>${escapeHtml(user.role)}</td>
            <td>
                <span class="badge ${statusBadgeClass}">
                    ${escapeHtml(statusText)}
                </span>
            </td>
            <td>${formatDate(user.registerDate)}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm me-2" onclick="editUser('${escapeHtml(user.email)}')">
                        <i class="bi bi-pencil"></i> แก้ไข
                    </button>
                    ${generateActionButtons(user)}
                </div>
            </td>
        </tr>
    `;
  }

  function toggleAllUsers(checkbox) {
    // เลือกเฉพาะ checkboxes ของผู้ใช้ที่มีสถานะ Pending
    $('.user-checkbox').prop('checked', checkbox.checked);
    checkBulkActionStatus();
  }

  function checkBulkActionStatus() {
    const checkedUsers = $('.user-checkbox:checked').length;
    const bulkApproveBtn = $('#bulkApproveBtn');
    const selectedCount = $('#selectedCount');

    // เพิ่มการจัดการเมื่อไม่มีการเลือกผู้ใช้
    if (checkedUsers > 0) {
      bulkApproveBtn.show().css('display', 'inline-flex').addClass('animate__animated animate__fadeIn');
      selectedCount.text(checkedUsers);
    } else {
      bulkApproveBtn.removeClass('animate__animated animate__fadeIn').hide();
      selectedCount.text('0'); // เพิ่มบรรทัดนี้เพื่อรีเซ็ตจำนวนเป็น 0
    }
  }
  const enhancedCheckboxStyles = `
<style>
/* Custom Checkbox Styling */
.custom-checkbox {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 24px;
}

.custom-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    opacity: 0;
    position: absolute;
    z-index: 2;
}

.custom-checkbox .checkmark {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    background-color: #fff;
    border: 2px solid #ddd;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.custom-checkbox input[type="checkbox"]:checked + .checkmark {
    background-color: #198754;
    border-color: #198754;
}

.custom-checkbox input[type="checkbox"]:checked + .checkmark:after {
    content: '';
    position: absolute;
    left: 5px;
    top: 2px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.custom-checkbox input[type="checkbox"]:hover + .checkmark {
    border-color: #198754;
}

.custom-checkbox input[type="checkbox"]:indeterminate + .checkmark {
    background-color: #6c757d;
    border-color: #6c757d;
}

.custom-checkbox input[type="checkbox"]:indeterminate + .checkmark:after {
    content: '';
    position: absolute;
    left: 3px;
    top: 7px;
    width: 10px;
    height: 2px;
    background: white;
}

/* Table Enhancements */
.table {
    --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
}

.table > :not(caption) > * > * {
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.table th {
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
}

/* Status Badge Enhancements */
.badge {
    font-weight: 500;
    padding: 0.5em 0.8em;
    border-radius: 6px;
    font-size: 0.85rem;
}

.bg-warning {
    background-color: #ffc107 !important;
    color: #000;
}

.bg-success {
    background-color: #198754 !important;
}

.bg-danger {
    background-color: #dc3545 !important;
}

/* Bulk Approve Button Enhancement */
#bulkApproveBtn {
    padding: 0.5rem 1rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    background-color: #198754;
    border: none;
}

#bulkApproveBtn:hover {
    background-color: #146c43;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#bulkApproveBtn i {
    font-size: 1.1rem;
}

#selectedCount {
    background: rgba(255,255,255,0.2);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-left: 0.25rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table th, .table td {
        padding: 0.75rem 0.5rem;
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    #bulkApproveBtn {
        width: 100%;
        justify-content: center;
    }
}
</style>
`;

  // เพิ่ม styles เข้าไปใน head
  document.head.insertAdjacentHTML('beforeend', enhancedCheckboxStyles);

  function approveBulkUsers() {
    const selectedEmails = $('.user-checkbox:checked')
      .map(function () {
        return $(this).data('email');
      })
      .get();

    if (selectedEmails.length === 0) {
      showAlert('กรุณาเลือกผู้ใช้ที่ต้องการอนุมัติ', 'warning');
      return;
    }

    Swal.fire({
      title: 'ยืนยันการอนุมัติผู้ใช้',
      html: `คุณแน่ใจหรือไม่ที่จะอนุมัติผู้ใช้จำนวน ${selectedEmails.length} คน?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'อนุมัติ',
      cancelButtonText: 'ยกเลิก',
      showLoaderOnConfirm: true,
      preConfirm: () => {
        return new Promise((resolve) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler((error) => {
              Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error}`);
            })
            .approveMultipleUsers(selectedEmails);
        });
      },
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          icon: 'success',
          title: 'อนุมัติผู้ใช้สำเร็จ',
          text: 'ระบบได้ส่งอีเมลแจ้งผู้ใช้ที่ได้รับการอนุมัติแล้ว',
        });
        loadUserList();
      }
    });
  }

  function generateActionButtons(user) {
    const buttons = [];

    // Edit button
    buttons.push(`
        <button 
            class="btn btn-outline-secondary btn-sm" 
            onclick="editUser('${escapeHtml(user.email)}')"
            data-bs-toggle="tooltip"
            title="แก้ไขข้อมูล"
        >
            <i class="bi bi-pencil"></i>
        </button>
    `);

    // Approval/Rejection buttons for pending users
    if (user.status === 'Pending') {
      buttons.push(`
            <button 
                class="btn btn-success btn-sm"
                onclick="confirmApproveUser('${escapeHtml(user.email)}')"
                data-bs-toggle="tooltip"
                title="อนุมัติผู้ใช้"
            >
                <i class="bi bi-check-circle"></i>
            </button>
            <button 
                class="btn btn-warning btn-sm"
                onclick="confirmRejectUser('${escapeHtml(user.email)}')"
                data-bs-toggle="tooltip"
                title="ปฏิเสธผู้ใช้"
            >
                <i class="bi bi-x-circle"></i>
            </button>
        `);
    }

    // Delete button
    buttons.push(`
        <button 
            class="btn btn-danger btn-sm"
            onclick="confirmDeleteUser('${escapeHtml(user.email)}')"
            data-bs-toggle="tooltip"
            title="ลบผู้ใช้"
        >
            <i class="bi bi-trash"></i>
        </button>
    `);

    return buttons.join('');
  }

  function getStatusBadgeClass(status) {
    return (
      {
        Pending: 'bg-warning',
        Approved: 'bg-success',
        Rejected: 'bg-danger',
        Inactive: 'bg-secondary',
      }[status] || 'bg-secondary'
    );
  }

  function getStatusText(status) {
    return (
      {
        Pending: 'รอการอนุมัติ',
        Approved: 'อนุมัติแล้ว',
        Rejected: 'ปฏิเสธ',
        Inactive: 'ระงับการใช้งาน',
      }[status] || status
    );
  }

  // เพิ่มฟังก์ชันสำหรับแสดงฟอร์มแก้ไข
  function populateEditForm(userData) {
    if (!userData) {
      showAlert('ไม่พบข้อมูลผู้ใช้', 'error');
      return;
    }

    currentEditingUser = userData; // เก็บข้อมูลผู้ใช้ที่กำลังแก้ไข

    // กำหนดค่าให้กับฟอร์ม
    $('#editUserEmail').val(userData.email);
    $('#editUserName').val(userData.name);
    $('#editUserRole').val(userData.role || 'User');

    // รีเซ็ตและกำหนดค่าให้กับ select สถานะ
    const $statusSelect = $('#editUserStatus');
    $statusSelect.empty();

    const statuses = [
      { value: 'Pending', text: 'รอการอนุมัติ' },
      { value: 'Approved', text: 'อนุมัติแล้ว' },
      { value: 'Rejected', text: 'ปฏิเสธ' },
    ];

    statuses.forEach((status) => {
      $statusSelect.append(
        $('<option>', {
          value: status.value,
          text: status.text,
          selected: status.value === userData.status,
        })
      );
    });

    // แสดงข้อมูลเพิ่มเติมตามสถานะ
    const statusInfo = `
        <div class="mt-3">
            <p><strong>สถานะปัจจุบัน:</strong> ${getStatusText(userData.status)}</p>
            <p><strong>วันที่ลงทะเบียน:</strong> ${formatDate(userData.registerDate)}</p>
            ${userData.status === 'Approved' ? `<p><strong>วันที่อนุมัติ:</strong> ${formatDate(userData.approvalDate)}</p>` : ''}
            ${userData.status === 'Rejected' ? `<p><strong>เหตุผลที่ปฏิเสธ:</strong> ${escapeHtml(userData.rejectionReason || '-')}</p>` : ''}
        </div>
    `;
    $('#userStatusInfo').html(statusInfo);

    // แสดง Modal
    $('#editUserModal').modal('show');
  }

  function updateUser() {
    if (!currentEditingUser) {
      showAlert('ไม่พบข้อมูลผู้ใช้ที่กำลังแก้ไข', 'error');
      return;
    }

    const updatedData = {
      email: $('#editUserEmail').val().trim(),
      name: $('#editUserName').val().trim(),
      role: $('#editUserRole').val(),
      status: $('#editUserStatus').val(),
      currentStatus: currentEditingUser.status,
    };

    if (!validateUserData(updatedData)) return;

    // ตรวจสอบการเปลี่ยนแปลงสถานะ
    if (updatedData.status !== updatedData.currentStatus) {
      handleStatusChange(updatedData);
    } else {
      saveUserData(updatedData);
    }
  }

  function saveUserData(userData) {
    showLoading('กำลังบันทึกข้อมูล...');

    google.script.run
      .withSuccessHandler((result) => {
        hideLoading();
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'บันทึกข้อมูลสำเร็จ',
            text: result.message,
            timer: 1500,
            timerProgressBar: true,
            showConfirmButton: false,
          }).then(() => {
            $('#editUserModal').modal('hide');
            loadUserList();
          });

          // แสดง Toast แจ้งเตือนเพิ่มเติม
          if (userData.status === 'Rejected') {
            Toast.warning(`ปฏิเสธผู้ใช้ ${userData.email} แล้ว`);
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'ไม่สามารถบันทึกข้อมูลได้',
            text: result.message,
            confirmButtonText: 'ตกลง',
          });
        }
      })
      .withFailureHandler((error) => {
        handleError(error, 'บันทึกข้อมูล');
      })
      .updateUserByAdmin(userData.email, userData);
  }

  function validateField($field) {
    const value = $field.val().trim();
    const fieldName = $field.attr('id').replace('editUser', '').toLowerCase();

    let isValid = true;
    let message = '';

    switch (fieldName) {
      case 'email':
        isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        message = 'กรุณากรอกอีเมลให้ถูกต้อง';
        break;
      case 'name':
        isValid = value.length >= 2;
        message = 'ชื่อต้องมีความยาวอย่างน้อย 2 ตัวอักษร';
        break;
    }

    if (!isValid) {
      $field.addClass('is-invalid').removeClass('is-valid');
      if (!$field.next('.invalid-feedback').length) {
        $field.after(`<div class="invalid-feedback">${message}</div>`);
      }
    } else {
      $field.removeClass('is-invalid').addClass('is-valid');
      $field.next('.invalid-feedback').remove();
    }

    return isValid;
  }

  const editUserStyles = `
.loading-spinner-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100px;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.modal .invalid-feedback {
    display: none;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.modal .is-invalid ~ .invalid-feedback {
    display: block;
}

.modal .form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,...");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
`;

  // เพิ่ม CSS ลงในหน้าเว็บ
  const editUserStyleSheet = document.createElement('style');
  editUserStyleSheet.textContent = editUserStyles;
  document.head.appendChild(editUserStyleSheet);

  // User Approval Management
  function confirmApproveUser(email) {
    showConfirmationDialog('ยืนยันการอนุมัติผู้ใช้', `คุณแน่ใจหรือไม่ที่จะอนุมัติผู้ใช้ ${email}?`, () => {
      showLoading();
      google.script.run
        .withSuccessHandler(onApprovalSuccess)
        .withFailureHandler((error) => handleFailure('อนุมัติผู้ใช้', error))
        .approveUser(email);
    });
  }

  function confirmRejectUser(email) {
    Swal.fire({
      title: 'ปฏิเสธผู้ใช้',
      text: 'กรุณาระบุเหตุผลในการปฏิเสธ:',
      input: 'textarea',
      inputPlaceholder: 'ระบุเหตุผล...',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'ปฏิเสธ',
      cancelButtonText: 'ยกเลิก',
      inputValidator: (value) => {
        if (!value) {
          return 'กรุณาระบุเหตุผลในการปฏิเสธ';
        }
      },
    }).then((result) => {
      if (result.isConfirmed) {
        showLoading();
        google.script.run
          .withSuccessHandler(onRejectionSuccess)
          .withFailureHandler((error) => handleFailure('ปฏิเสธผู้ใช้', error))
          .rejectUser(email, result.value);
      }
    });
  }

  // Password Management
  function showResetPasswordConfirmation() {
    const email = $('#editUserEmail').val();
    showConfirmationDialog('ยืนยันการรีเซ็ตรหัสผ่าน', `คุณแน่ใจหรือไม่ที่จะรีเซ็ตรหัสผ่านของผู้ใช้ ${email}?`, () => resetUserPassword(email));
  }

  function resetUserPassword(email) {
    showLoading();
    google.script.run
      .withSuccessHandler(onResetSuccess)
      .withFailureHandler((error) => handleFailure('รีเซ็ตรหัสผ่าน', error))
      .resetUserPassword(email);
  }

  // User Deletion
  function confirmDeleteUser(email) {
    showConfirmationDialog('ยืนยันการลบผู้ใช้', `คุณแน่ใจหรือไม่ที่จะลบผู้ใช้ ${email}? การดำเนินการนี้ไม่สามารถย้อนกลับได้`, () =>
      deleteUser(email)
    );
  }

  function deleteUser(email) {
    showLoading();
    google.script.run
      .withSuccessHandler(onDeleteSuccess)
      .withFailureHandler((error) => handleFailure('ลบผู้ใช้', error))
      .deleteUser(email);
  }

  // Success Handlers
  function onUpdateSuccess(result) {
    handleOperationSuccess(result, 'อัพเดตข้อมูลผู้ใช้สำเร็จ', () => {
      $('#editUserModal').modal('hide');
      loadUserList();
    });
  }

  function onApprovalSuccess(result) {
    handleOperationSuccess(result, 'อนุมัติผู้ใช้สำเร็จ', loadUserList);
  }

  function onRejectionSuccess(result) {
    handleOperationSuccess(result, 'ปฏิเสธผู้ใช้สำเร็จ', loadUserList);
  }

  function onResetSuccess(result) {
    hideLoading();
    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'รีเซ็ตรหัสผ่านสำเร็จ',
        html: `รหัสผ่านใหม่คือ: <strong>${result.newPassword}</strong>`,
        confirmButtonText: 'ตกลง',
      });
    } else {
      showAlert(result.message || 'ไม่สามารถรีเซ็ตรหัสผ่านได้', 'error');
    }
  }

  function onDeleteSuccess(result) {
    handleOperationSuccess(result, 'ลบผู้ใช้สำเร็จ', loadUserList);
  }

  // Utility Functions
  function handleOperationSuccess(result, successMessage, callback) {
    hideLoading();
    if (result.success) {
      showAlert(successMessage, 'success');
      if (callback) callback();
    } else {
      showAlert(result.message || 'การดำเนินการไม่สำเร็จ', 'error');
    }
  }

  function handleFailure(operation, error) {
    hideLoading();
    console.error(`${operation} error:`, error);
    showAlert(`เกิดข้อผิดพลาดในการ${operation}: ${error}`, 'error');
  }

  function showLoading() {
    // ตรวจสอบและปิด loading เก่าก่อน (ถ้ามี)
    Swal.close();

    return Swal.fire({
      title: 'กำลังดำเนินการ...',
      allowOutsideClick: false,
      allowEscapeKey: false,
      allowEnterKey: false,
      showConfirmButton: false,
      showCancelButton: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });
  }

  // แก้ไขฟังก์ชัน hideLoading
  function hideLoading() {
    try {
      Swal.close();
    } catch (error) {
      console.error('Error hiding loading:', error);
    }
  }

  function formatDate(date) {
    if (!date) return 'N/A';
    const d = new Date(date);
    return d.toLocaleDateString('th-TH', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  function showAlert(message, type) {
    hideLoading(); // ปิด loading ก่อนแสดง alert

    return Swal.fire({
      icon: type,
      title: type.charAt(0).toUpperCase() + type.slice(1),
      text: message,
      timer: 3000,
      timerProgressBar: true,
      showConfirmButton: false,
    });
  }

  function showConfirmationDialog(title, message, onConfirm) {
    Swal.fire({
      title: title,
      text: message,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'ยืนยัน',
      cancelButtonText: 'ยกเลิก',
    }).then((result) => {
      if (result.isConfirmed) {
        onConfirm();
      }
    });
  }

  function escapeHtml(unsafe) {
    return unsafe
      ? String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')
      : '';
  }

  function handleEditUserSubmit(e) {
    e.preventDefault();
    const userData = {
      email: $('#editUserEmail').val().trim(),
      name: $('#editUserName').val().trim(),
      role: $('#editUserRole').val(),
      status: $('#editUserStatus').val(),
    };

    // เพิ่มการตรวจสอบข้อมูล
    if (!validateUserData(userData)) {
      return;
    }

    // ถ้าสถานะเป็น Rejected ต้องมีเหตุผล
    if (userData.status === 'Rejected') {
      Swal.fire({
        title: 'ระบุเหตุผลในการปฏิเสธ',
        input: 'textarea',
        inputPlaceholder: 'กรุณาระบุเหตุผล...',
        showCancelButton: true,
        confirmButtonText: 'บันทึก',
        cancelButtonText: 'ยกเลิก',
        inputValidator: (value) => {
          if (!value) {
            return 'กรุณาระบุเหตุผลในการปฏิเสธ';
          }
        },
      }).then((result) => {
        if (result.isConfirmed) {
          userData.rejectionReason = result.value;
          saveUserChanges(userData);
        }
      });
    } else {
      saveUserChanges(userData);
    }
  }

  function validateUserData(userData) {
    const validationRules = {
      email: {
        required: true,
        pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        message: 'กรุณากรอกอีเมลให้ถูกต้อง',
      },
      name: {
        required: true,
        minLength: 2,
        message: 'ชื่อต้องมีความยาวอย่างน้อย 2 ตัวอักษร',
      },
      role: {
        required: true,
        values: ['User', 'Admin'],
        message: 'กรุณาเลือกบทบาทที่ถูกต้อง',
      },
      status: {
        required: true,
        values: ['Pending', 'Approved', 'Rejected'],
        message: 'กรุณาเลือกสถานะที่ถูกต้อง',
      },
    };

    const errors = [];

    Object.keys(validationRules).forEach((field) => {
      const rule = validationRules[field];
      const value = userData[field];

      if (rule.required && !value) {
        errors.push(`กรุณากรอก${field}`);
      }

      if (value && rule.pattern && !rule.pattern.test(value)) {
        errors.push(rule.message);
      }

      if (value && rule.minLength && value.length < rule.minLength) {
        errors.push(rule.message);
      }

      if (value && rule.values && !rule.values.includes(value)) {
        errors.push(rule.message);
      }
    });

    if (errors.length > 0) {
      Swal.fire({
        icon: 'warning',
        title: 'ข้อมูลไม่ถูกต้อง',
        html: errors.join('<br>'),
        confirmButtonText: 'ตกลง',
      });
      return false;
    }

    return true;
  }

  function saveUserChanges(userData) {
    showLoading();
    google.script.run
      .withSuccessHandler(function (result) {
        hideLoading();
        if (result.success) {
          $('#editUserModal').modal('hide');
          showAlert('อัพเดตข้อมูลสำเร็จ', 'success');
          loadUserList(); // โหลดรายการผู้ใช้ใหม่
        } else {
          showAlert(result.message || 'ไม่สามารถอัพเดตข้อมูลได้', 'error');
        }
      })
      .withFailureHandler(function (error) {
        hideLoading();
        showAlert('เกิดข้อผิดพลาด: ' + error, 'error');
      })
      .updateUserByAdmin(userData.email, userData);
  }

  function isValidEmail(email) {
    // รูปแบบอีเมลที่ถูกต้อง
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailRegex.test(email);
  }

  function escapeHtml(unsafe) {
    return unsafe
      ? String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')
      : '';
  }

  function editUser(email) {
    console.log('Editing user:', email);
    showLoading();

    // หาข้อมูลผู้ใช้จาก allUsers
    const userData = allUsers.find((user) => user.email === email);
    if (userData) {
      currentEditingUser = userData; // เก็บข้อมูลผู้ใช้ที่กำลังแก้ไข
      populateEditForm(userData);
      hideLoading();
    } else {
      // ถ้าไม่พบในข้อมูลที่มีอยู่ ให้โหลดใหม่จาก server
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result) {
            currentEditingUser = result; // เก็บข้อมูลผู้ใช้ที่กำลังแก้ไข
            populateEditForm(result);
          } else {
            showAlert('ไม่พบข้อมูลผู้ใช้', 'error');
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error, 'error');
        })
        .getUserData(email);
    }
  }
  // เพิ่มตอนเริ่มต้นไฟล์
  window.onerror = function (message, source, lineno, colno, error) {
    console.error('Global error:', { message, source, lineno, colno, error });
    hideLoading(); // ปิด loading ถ้ามี error ที่ไม่ได้จัดการ
    showAlert('เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณาลองใหม่อีกครั้ง', 'error');
    return false;
  };

  // เพิ่ม catch block สำหรับ Promise
  window.addEventListener('unhandledrejection', function (event) {
    console.error('Unhandled promise rejection:', event.reason);
    hideLoading();
    showAlert('เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณาลองใหม่อีกครั้ง', 'error');
  });

  function handleError(error, operation) {
    console.error(`Error in ${operation}:`, error);
    hideLoading();

    Swal.fire({
      icon: 'error',
      title: 'เกิดข้อผิดพลาด',
      text: `เกิดข้อผิดพลาดในการ${operation}: ${error.message || error}`,
      confirmButtonText: 'ตกลง',
    });
  }

  function handleStatusChange(userData) {
    if (userData.status === 'Rejected') {
      Swal.fire({
        title: 'ปฏิเสธผู้ใช้',
        input: 'textarea',
        inputLabel: 'เหตุผลในการปฏิเสธ',
        inputPlaceholder: 'กรุณาระบุเหตุผล...',
        inputAttributes: {
          'aria-label': 'เหตุผลในการปฏิเสธ',
        },
        showCancelButton: true,
        confirmButtonText: 'ยืนยันการปฏิเสธ',
        cancelButtonText: 'ยกเลิก',
        showLoaderOnConfirm: true,
        inputValidator: (value) => {
          if (!value) {
            return 'กรุณาระบุเหตุผลในการปฏิเสธ';
          }
          if (value.trim().length < 10) {
            return 'กรุณาระบุเหตุผลอย่างน้อย 10 ตัวอักษร';
          }
        },
        preConfirm: (rejectionReason) => {
          // ถ้ามีการกด confirm จะเก็บเหตุผลและส่งต่อไปยังฟังก์ชันบันทึก
          userData.rejectionReason = rejectionReason.trim();
          return userData;
        },
      }).then((result) => {
        if (result.isConfirmed) {
          saveUserData(result.value);
        } else {
          // ถ้าผู้ใช้ยกเลิก ให้เปลี่ยนค่า select กลับไปเป็นค่าเดิม
          $('#editUserStatus').val(userData.currentStatus);
        }
      });
    } else {
      // กรณีเปลี่ยนสถานะอื่นๆ
      const statusMessages = {
        Approved: 'คุณต้องการอนุมัติผู้ใช้นี้ใช่หรือไม่?',
        Pending: 'คุณต้องการเปลี่ยนสถานะเป็นรอการอนุมัติใช่หรือไม่?',
      };

      Swal.fire({
        title: 'ยืนยันการเปลี่ยนสถานะ',
        text: statusMessages[userData.status] || 'คุณต้องการเปลี่ยนสถานะใช่หรือไม่?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก',
      }).then((result) => {
        if (result.isConfirmed) {
          saveUserData(userData);
        } else {
          // ถ้าผู้ใช้ยกเลิก ให้เปลี่ยนค่า select กลับไปเป็นค่าเดิม
          $('#editUserStatus').val(userData.currentStatus);
        }
      });
    }
  }

  function logUserAction(email, action, details) {
    const timestamp = new Date().toISOString();
    showLoading('กำลังบันทึกประวัติ...');

    google.script.run
      .withSuccessHandler(() => hideLoading())
      .withFailureHandler((error) => handleError(error, 'บันทึกประวัติ'))
      .logUserActivity(email, action, {
        ...details,
        timestamp,
        performedBy: currentUser?.email,
      });
  }

  // Helper functions ต้องอยู่ด้านบนก่อน
  function getActionText(action) {
    const actionTexts = {
      UPDATE_USER: 'แก้ไขข้อมูล',
      APPROVE_USER: 'อนุมัติผู้ใช้',
      REJECT_USER: 'ปฏิเสธผู้ใช้',
      DELETE_USER: 'ลบผู้ใช้',
      CREATE_USER: 'เพิ่มผู้ใช้',
      RESET_PASSWORD: 'รีเซ็ตรหัสผ่าน',
    };
    return actionTexts[action] || action;
  }

  function getActionBadgeClass(action) {
    const badgeClasses = {
      UPDATE_USER: 'bg-primary',
      APPROVE_USER: 'bg-success',
      REJECT_USER: 'bg-danger',
      DELETE_USER: 'bg-danger',
      CREATE_USER: 'bg-info',
      RESET_PASSWORD: 'bg-warning',
    };
    return badgeClasses[action] || 'bg-secondary';
  }

  function getDefaultActionText(action) {
    const defaultTexts = {
      CREATE_USER: 'เพิ่มผู้ใช้ใหม่เข้าระบบ',
      DELETE_USER: 'ลบผู้ใช้ออกจากระบบ',
      RESET_PASSWORD: 'ทำการรีเซ็ตรหัสผ่าน',
      UPDATE_USER: 'อัพเดตข้อมูลผู้ใช้',
    };
    return defaultTexts[action] || 'ดำเนินการสำเร็จ';
  }

  // แล้วค่อยประกาศฟังก์ชัน displayUserHistory
  function displayUserHistory(history) {
    hideLoading();

    if (!history || history.length === 0) {
      Swal.fire({
        icon: 'info',
        title: 'ประวัติการดำเนินการ',
        text: 'ไม่พบประวัติการดำเนินการ',
        confirmButtonText: 'ตกลง',
      });
      return;
    }

    const historyHTML = history
      .map((entry) => {
        // แปลงข้อมูล details จาก JSON string เป็น object
        let details;
        try {
          details = typeof entry.details === 'string' ? JSON.parse(entry.details) : entry.details;
        } catch (e) {
          details = entry.details;
        }

        // สร้าง HTML สำหรับแสดงการเปลี่ยนแปลง
        const changes = [];
        if (details.oldStatus !== details.newStatus) {
          changes.push(`สถานะ: ${details.oldStatus || '-'} → ${details.newStatus || '-'}`);
        }
        if (details.oldName !== details.newName) {
          changes.push(`ชื่อ: ${details.oldName || '-'} → ${details.newName || '-'}`);
        }
        if (details.oldRole !== details.newRole) {
          changes.push(`บทบาท: ${details.oldRole || '-'} → ${details.newRole || '-'}`);
        }

        return `
            <tr>
                <td class="text-nowrap">${entry.timestamp}</td>
                <td>
                    <span class="badge ${getActionBadgeClass(entry.action)}">${getActionText(entry.action)}</span>
                </td>
                <td>${entry.performedBy}</td>
                <td>
                    <div class="changes-list">
                        ${
                          changes.length > 0
                            ? changes.map((change) => `<div class="change-item">${change}</div>`).join('')
                            : getDefaultActionText(entry.action)
                        }
                    </div>
                    <div class="text-muted small">
                        ${details.timestamp || ''}
                    </div>
                </td>
            </tr>
        `;
      })
      .join('');

    Swal.fire({
      title: 'ประวัติการดำเนินการ',
      html: `
            <div class="history-container">
                <table class="table table-hover table-striped align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>วันที่-เวลา</th>
                            <th>การดำเนินการ</th>
                            <th>ดำเนินการโดย</th>
                            <th>รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historyHTML}
                    </tbody>
                </table>
            </div>
        `,
      width: '900px',
      confirmButtonText: 'ปิด',
      didOpen: () => {
        // เพิ่ม CSS inline
        const style = document.createElement('style');
        style.textContent = `
                .history-container {
                    max-height: 500px;
                    overflow-y: auto;
                }
                .changes-list {
                    margin-bottom: 0.5rem;
                }
                .change-item {
                    padding: 2px 0;
                }
                .badge {
                    font-size: 0.875rem;
                    padding: 0.4em 0.8em;
                }
                .table td {
                    vertical-align: middle;
                    padding: 0.75rem;
                }
                .table th {
                    background-color: #f8f9fa;
                    font-weight: 600;
                }
            `;
        document.head.appendChild(style);
      },
    });
  }

  function showUserHistory(email) {
    showLoading('กำลังโหลดประวัติ...');

    google.script.run
      .withSuccessHandler(displayUserHistory)
      .withFailureHandler((error) => handleError(error, 'โหลดประวัติ'))
      .getUserActivityLog(email);
  }

  function setupAdvancedSearch() {
    const filterContainer = $('<div>', {
      class: 'mb-3 p-3 bg-light rounded',
    }).insertBefore('#userListContainer');

    filterContainer.html(`
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="searchText" placeholder="ค้นหา...">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="roleFilter">
                    <option value="">- บทบาททั้งหมด -</option>
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="statusFilter">
                    <option value="">- สถานะทั้งหมด -</option>
                    <option value="Pending">รอการอนุมัติ</option>
                    <option value="Approved">อนุมัติแล้ว</option>
                    <option value="Rejected">ปฏิเสธ</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <input type="date" class="form-control" id="dateFrom">
                    <span class="input-group-text">ถึง</span>
                    <input type="date" class="form-control" id="dateTo">
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                    <i class="bi bi-filter"></i> กรอง
                </button>
            </div>
        </div>
    `);

    // Event listeners สำหรับการค้นหาแบบ Real-time
    $('#searchText').on('input', debounce(applyFilters, 300));
    $('#roleFilter, #statusFilter').on('change', applyFilters);
  }

  function applyFilters() {
    const filters = {
      searchText: $('#searchText').val().toLowerCase(),
      role: $('#roleFilter').val(),
      status: $('#statusFilter').val(),
      dateFrom: $('#dateFrom').val(),
      dateTo: $('#dateTo').val(),
    };

    const filteredUsers = allUsers.filter((user) => {
      // ค้นหาจากข้อความ
      if (filters.searchText && !Object.values(user).some((value) => String(value).toLowerCase().includes(filters.searchText))) {
        return false;
      }

      // กรองตามบทบาท
      if (filters.role && user.role !== filters.role) {
        return false;
      }

      // กรองตามสถานะ
      if (filters.status && user.status !== filters.status) {
        return false;
      }

      // กรองตามวันที่
      if (filters.dateFrom || filters.dateTo) {
        const userDate = new Date(user.registerDate);
        if (filters.dateFrom && userDate < new Date(filters.dateFrom)) {
          return false;
        }
        if (filters.dateTo && userDate > new Date(filters.dateTo)) {
          return false;
        }
      }

      return true;
    });

    displayFilteredUsers(filteredUsers);
    updateFilterStats(filteredUsers);
  }

  function updateFilterStats(filteredUsers) {
    const statsContainer = $('<div>', {
      class: 'mt-2 mb-3 d-flex justify-content-between align-items-center',
    });

    const totalUsers = allUsers.length;
    const filteredCount = filteredUsers.length;

    statsContainer.insertAfter('#userListContainer');
  }

  // 5. เพิ่มฟังก์ชัน Debounce สำหรับการค้นหา
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 6. ปรับปรุง UI ของปุ่มดำเนินการ
  function generateActionButtons(user) {
    return `
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary btn-sm" 
                    onclick="editUser('${escapeHtml(user.email)}')"
                    data-bs-toggle="tooltip" 
                    title="แก้ไขข้อมูล">
                <i class="bi bi-pencil"></i>
            </button>
            
            <button class="btn btn-outline-info btn-sm" 
                    onclick="showUserHistory('${escapeHtml(user.email)}')"
                    data-bs-toggle="tooltip" 
                    title="ดูประวัติการดำเนินการ">
                <i class="bi bi-clock-history"></i>
            </button>
            
            ${
              user.status === 'Pending'
                ? `
                <button class="btn btn-outline-success btn-sm" 
                        onclick="confirmApproveUser('${escapeHtml(user.email)}')"
                        data-bs-toggle="tooltip" 
                        title="อนุมัติผู้ใช้">
                    <i class="bi bi-check-lg"></i>
                </button>
                
                <button class="btn btn-outline-warning btn-sm" 
                        onclick="confirmRejectUser('${escapeHtml(user.email)}')"
                        data-bs-toggle="tooltip" 
                        title="ปฏิเสธผู้ใช้">
                    <i class="bi bi-x-lg"></i>
                </button>
            `
                : ''
            }
            
            <button class="btn btn-outline-danger btn-sm" 
                    onclick="confirmDeleteUser('${escapeHtml(user.email)}')"
                    data-bs-toggle="tooltip" 
                    title="ลบผู้ใช้">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
  }

  const editUserAdditionalStyles = `
.btn-group .btn {
    padding: 0.25rem 0.5rem;
    margin: 0 1px;
}

.btn-group .btn i {
    font-size: 1rem;
}

.tooltip {
    font-size: 0.875rem;
}

.filter-container {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.stats-container {
    font-size: 0.875rem;
    color: #6c757d;
}

.table-responsive {
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        flex: 1;
        min-width: 2.5rem;
    }
}
`;

  // เพิ่ม CSS ลงในหน้าเว็บ
  const additionalStyleSheet = document.createElement('style');
  additionalStyleSheet.textContent = editUserAdditionalStyles;
  document.head.appendChild(additionalStyleSheet);

  // เพิ่มฟังก์ชันตรวจสอบความปลอดภัยของรหัสผ่าน
  function validatePasswordStrength(password) {
    const requirements = {
      length: password.length >= 8,
      lowercase: /[a-z]/.test(password),
      uppercase: /[A-Z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
    };

    // ตรวจสอบความแข็งแรงของรหัสผ่าน
    const strengthLevel = Object.values(requirements).filter(Boolean).length;

    const getRequirementText = () => {
      const missing = [];
      if (!requirements.length) missing.push('- ความยาวอย่างน้อย 8 ตัวอักษร');
      if (!requirements.lowercase) missing.push('- ตัวอักษรพิมพ์เล็ก');
      if (!requirements.uppercase) missing.push('- ตัวอักษรพิมพ์ใหญ่');
      if (!requirements.number) missing.push('- ตัวเลข');
      if (!requirements.special) missing.push('- อักขระพิเศษ');
      return missing.join('<br>');
    };

    return {
      isValid: strengthLevel >= 4,
      message: strengthLevel < 4 ? 'รหัสผ่านไม่ปลอดภัย กรุณาตรวจสอบข้อกำหนดต่อไปนี้:<br>' + getRequirementText() : 'รหัสผ่านปลอดภัย',
    };
  }
</script>
